import os
import json
import requests
import time
import logging
from dotenv import load_dotenv

logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
logger = logging.getLogger(__name__)
load_dotenv()

GROQ_API_KEY = os.getenv('GROQ_API_KEY')
if not GROQ_API_KEY:
    logger.critical("GROQ_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)!")
    exit(1)

GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions"
MODEL = "llama-3.3-70b-versatile"
OUTPUT_FILE = "questions_new.json"

TEMPLATES = {
    "single": """{
    "type": "single",
    "question": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞?",
    "options": ["–í–∞—Ä–∏–∞–Ω—Ç –ê", "–í–∞—Ä–∏–∞–Ω—Ç –ë", "–í–∞—Ä–∏–∞–Ω—Ç –í", "–í–∞—Ä–∏–∞–Ω—Ç –ì"],
    "correct": 0,
    "hint": "–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏"
}""",
    "multiple": """{
    "type": "multiple",
    "question": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞?",
    "options": ["–í–∞—Ä–∏–∞–Ω—Ç 1", "–í–∞—Ä–∏–∞–Ω—Ç 2", "–í–∞—Ä–∏–∞–Ω—Ç 3", "–í–∞—Ä–∏–∞–Ω—Ç 4"],
    "correct": [0, 2]
    "hint": "–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏"
}""",
    "matching": """{
    "type": "matching",
    "question": "–°–æ–µ–¥–∏–Ω–∏...",
    "leftItems": ["–¢–µ—Ä–º–∏–Ω 1", "–¢–µ—Ä–º–∏–Ω 2", "–¢–µ—Ä–º–∏–Ω 3", "–¢–µ—Ä–º–∏–Ω 4"],
    "rightItems": ["–û–ø—Ä 1", "–û–ø—Ä 2", "–û–ø—Ä 3", "–û–ø—Ä 4"],
    "correctPairs": {
        "–¢–µ—Ä–º–∏–Ω 1": "–û–ø—Ä 1",
        "–¢–µ—Ä–º–∏–Ω 2": "–û–ø—Ä 2",
        "–¢–µ—Ä–º–∏–Ω 3": "–û–ø—Ä 3",
        "–¢–µ—Ä–º–∏–Ω 4": "–û–ø—Ä 4"
    },
    "hint": "–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏"
}""",
    "sequence": """{
    "type": "sequence",
    "question": "–†–∞—Å—Å—Ç–∞–≤—å –ø–æ—Ä—è–¥–æ–∫...",
    "steps": ["–®–∞–≥ 1", "–®–∞–≥ 2", "–®–∞–≥ 3", "–®–∞–≥ 4", "–®–∞–≥ 5"],
    "correctOrder": [0, 1, 2, 3, 4],
    "hint": "–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏"
}""",
    "fill-blanks": """{
    "type": "fill-blanks",
    "question": "–ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∏...",
    "code": "–¢–µ–∫—Å—Ç –¥–æ <span class=\\"blank\\" data-id=\\"1\\">______</span> —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ <span class=\\"blank\\" data-id=\\"2\\">______</span>.",
    "blanks": {
        "1": ["–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π1", "–Ω–µ–≤–µ—Ä–Ω—ã–π1"],
        "2": ["–Ω–µ–≤–µ—Ä–Ω—ã–π1", "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π2", "–Ω–µ–≤–µ—Ä–Ω—ã–π2"]
    },
    "correct": ["–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π1", "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π2"],
    "hint": "–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏"
}""",
    "find-error": """{
    "type": "find-error",
    "question": "–ù–∞–π–¥–∏ –æ—à–∏–±–∫—É:",
    "code": ["–ü—Ä–∞–≤–∏–ª—å–Ω–æ", "–ü—Ä–∞–≤–∏–ª—å–Ω–æ", "–û—à–∏–±–∫–∞", "–ü—Ä–∞–≤–∏–ª—å–Ω–æ"],
    "errorLine": 3,
    "hint": "–¢–µ–∫—Å—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏"
}"""
}


CONTEXT_REGISTRY = [
    {
        "topic": "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã",
        "difficulty": "easy",
        "q_types": ["single", "fill-blanks"],
        "legal_text": """
        –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Ñ–ª–∞–≥ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ë–µ–ª–∞—Ä—É—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–µ –ø–æ–ª–æ—Ç–Ω–∏—â–µ, —Å–æ—Å—Ç–æ—è—â–µ–µ –∏–∑ –¥–≤—É—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–Ω—ã—Ö –ø–æ–ª–æ—Å: –≤–µ—Ä—Ö–Ω–µ–π ‚Äî –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –∏ –Ω–∏–∂–Ω–µ–π ‚Äî –∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞. –û—Ç–Ω–æ—à–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –ø–æ–ª–æ—Å –∫—Ä–∞—Å–Ω–æ–≥–æ –∏ –∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ ‚Äî 2:1. –£ –¥—Ä–µ–≤–∫–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ä–Ω–∞–º–µ–Ω—Ç –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –Ω–∞ –±–µ–ª–æ–º –ø–æ–ª–µ, —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π 1/9 –¥–ª–∏–Ω—ã —Ñ–ª–∞–≥–∞.
        """
    },
    {
        "topic": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å",
        "difficulty": "medium",
        "q_types": ["single", "find-error"],
        "legal_text": """
        –°—Ç–∞—Ç—å—è 19.1 –ö–æ–ê–ü –†–ë. –ú–µ–ª–∫–æ–µ —Ö—É–ª–∏–≥–∞–Ω—Å—Ç–≤–æ.
        –û—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏—Å—Ç–∞–≤–∞–Ω–∏–µ –∫ –≥—Ä–∞–∂–¥–∞–Ω–∞–º –∏ –¥—Ä—É–≥–∏–µ —É–º—ã—à–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –Ω–∞—Ä—É—à–∞—é—â–∏–µ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫, –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –∏–ª–∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –≥—Ä–∞–∂–¥–∞–Ω –∏ –≤—ã—Ä–∞–∂–∞—é—â–∏–µ—Å—è –≤ —è–≤–Ω–æ–º –Ω–µ—É–≤–∞–∂–µ–Ω–∏–∏ –∫ –æ–±—â–µ—Å—Ç–≤—É, –≤–ª–µ–∫—É—Ç –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ –æ—Ç 2 –¥–æ 30 –±–∞–∑–æ–≤—ã—Ö –≤–µ–ª–∏—á–∏–Ω, –∏–ª–∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã, –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –∞—Ä–µ—Å—Ç.
        –í–æ–∑—Ä–∞—Å—Ç –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: 14 –ª–µ—Ç.
        """
    },
    # –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ –±–ª–æ–∫–∏ (–ü–î–î, –õ–µ—Å –∏ —Ç.–¥.)
]


def clean_json_response(text: str) -> str:
    text = text.strip()
    if text.startswith("```json"):
        text = text[7:]
    if text.startswith("```"):
        text = text[3:]
    if text.endswith("```"):
        text = text[:-3]
    return text.strip()


def generate_questions_with_context(context_data):

    topic = context_data['topic']
    difficulty = context_data['difficulty']
    legal_text = context_data['legal_text']

    generated_batch = []

    for q_type in context_data['q_types']:
        count = 5
        logger.info(f"üöÄ Groq –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç: {topic} ({difficulty}) -> {q_type}")

        prompt = f"""
        –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–∞–≤—É –∏ –ø–µ–¥–∞–≥–æ–≥. –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: —à–∫–æ–ª—å–Ω–∏–∫–∏ 8-16 –ª–µ—Ç.
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å {count} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –Ω–∞ –æ—Å–Ω–æ–≤–µ –ü–†–ï–î–û–°–¢–ê–í–õ–ï–ù–ù–û–ì–û –¢–ï–ö–°–¢–ê –ó–ê–ö–û–ù–ê.

        –í–•–û–î–ù–û–ô –¢–ï–ö–°–¢ –ó–ê–ö–û–ù–ê (–ö–û–ù–¢–ï–ö–°–¢):
        "{legal_text}"

        –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
        1. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ñ–∞–∫—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –≤—ã—à–µ. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ç–æ–≥–æ, —á–µ–≥–æ –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ.
        2. –Ø–∑—ã–∫: –†—É—Å—Å–∫–∏–π.
        3. –¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞: {q_type}.
        4. –®–∞–±–ª–æ–Ω JSON –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞: {TEMPLATES[q_type]}
        5. –°–ª–æ–∂–Ω–æ—Å—Ç—å: {difficulty}. –ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞–π —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é, –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
        6. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–π Hint (–ü–æ–¥—Å–∫–∞–∑–∫—É): –î–æ–ª–∂–Ω–∞ –Ω–∞–≤–æ–¥–∏—Ç—å –Ω–∞ –º—ã—Å–ª—å, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä—è–º–æ–π –æ—Ç–≤–µ—Ç.
        7. –í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã —á—ë—Ç–∫–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è, –Ω–µ–≤–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º–∏. –¢–≤–æ—è —Ü–µ–ª—å - –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å.        

        –í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –º–∞—Å—Å–∏–≤: [{TEMPLATES[q_type]}, ...]. 
        –ù–µ –ø–∏—à–∏ –Ω–∏–∫–∞–∫–∏—Ö –≤–≤–æ–¥–Ω—ã—Ö —Å–ª–æ–≤ –≤—Ä–æ–¥–µ "–í–æ—Ç –≤–∞—à JSON". –¢–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π –∫–æ–¥.
        """

        headers = {
            "Authorization": f"Bearer {GROQ_API_KEY}",
            "Content-Type": "application/json"
        }

        data = {
            "model": MODEL,
            "messages": [
                {"role": "system",
                 "content": "–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON –º–∞—Å—Å–∏–≤–æ–º."},
                {"role": "user", "content": prompt}
            ],
            "temperature": 0.4,
            "max_tokens": 4096
        }

        try:
            print(prompt)
            response = requests.post(GROQ_API_URL, headers=headers, json=data)
            response.raise_for_status()

            result = response.json()
            content = result['choices'][0]['message']['content']

            cleaned_content = clean_json_response(content)
            result_json = json.loads(cleaned_content)

            # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫ –≤–æ–ø—Ä–æ—Å–∞–º
            for q in result_json:
                q['topic'] = topic
                q['difficulty'] = difficulty
                q['source_ref'] = "context_based_groq"

            generated_batch.extend(result_json)
            # Groq –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π, –Ω–æ –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–æ–ª–µ–∑–Ω–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            time.sleep(1)

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ Groq ({q_type}): {e}")
            if 'response' in locals() and response.status_code != 200:
                logger.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ API: {response.text}")

    return generated_batch


def main():
    all_questions = []

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if os.path.exists(OUTPUT_FILE):
        try:
            with open(OUTPUT_FILE, 'r', encoding='utf-8') as f:
                all_questions = json.load(f)
                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(all_questions)} –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞.")
        except:
            pass

    # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ä–µ–µ—Å—Ç—Ä—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
    for context_entry in CONTEXT_REGISTRY:
        new_q = generate_questions_with_context(context_entry)
        if new_q:
            all_questions.extend(new_q)
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
            with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                json.dump(all_questions, f, ensure_ascii=False, indent=2)
            logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ +{len(new_q)} –≤–æ–ø—Ä–æ—Å–æ–≤.")

    logger.info(f"\nüéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑–µ: {len(all_questions)}")


if __name__ == "__main__":
    main()