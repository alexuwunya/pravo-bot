import os
import json
import requests
import time
import logging
import hashlib
import re
from dotenv import load_dotenv

# --- НАСТРОЙКИ ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
load_dotenv()

GROQ_API_KEY = os.getenv('GROQ_API_KEY')
if not GROQ_API_KEY:
    logger.critical("❌ GROQ_API_KEY не найден!")
    exit(1)

GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions"
MODEL = "llama-3.3-70b-versatile"
OUTPUT_FILE = "html/questions.json"

MAX_RETRIES = 3
BASE_DELAY = 5
# Сколько вопросов КАЖДОГО типа мы хотим иметь в итоге по каждой теме
TARGET_PER_TYPE = 5
BATCH_SIZE = 5  # Сколько запрашиваем у нейросети за один раз

CONTEXT_REGISTRY = [
    {
        "topic": "Государственные символы",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Государственный флаг Республики Беларусь является символом государственного суверенитета Республики Беларусь, представляет собой прямоугольное полотнище, состоящее из двух горизонтально расположенных цветных полос: верхней - красного цвета в 2/3 ширины флага и нижней - зеленого цвета в 1/3.
Около древка вертикально расположен белорусский национальный орнамент красного цвета на белом поле, составляющий малую часть длины флага. Отношение ширины флага к его длине - 1:2. Флаг крепится на древке (флагштоке), которое окрашивается в золотистый (охра) цвет.
Государственный флаг постоянно поднят на зданиях органов власти и некоторых государственных учреждений, устанавливается в служебных кабинетах руководителей данных органов (учреждений), в школах, на избирательных участках, вывешивается во время различных торжественных мероприятий.

Государственный герб Республики Беларусь является символом государственного суверенитета Республики Беларусь. Он представляет собой размещенный в серебряном поле золотой контур Государственной границы Республики Беларусь, наложенный на золотые лучи восходящего над земным шаром солнца. Вверху поля находится пятиконечная красная звезда. Герб обрамлен венком из золотых колосьев, переплетенных справа цветками клевера, слева - цветками льна. Венок трижды перевит с каждой стороны красно-зеленой лентой, в средней части которой в основании Государственного герба Республики Беларусь в две строки начертаны золотом слова "Рэспубліка Беларусь".
Изображение Государственного герба размещается на зданиях органов власти и ряда государственных учреждений, внутри служебных кабинетов их руководителей, а также на печатях данных органов, на монетах, паспортах граждан Республики Беларусь. В отличие от Государственного флага, Государственный герб имеет более официальное значение.

Государственный гимн Республики Беларусь представляет собой музыкально-поэтическое произведение, исполняемое в торжественных случаях.
Мы, беларусы–мірныя людзі,
Сэрцам адданыя роднай зямлі,
Шчыра сябруем, сілы гартуем
Мы ў працавітай, вольнай сям’і.

Слаўся, зямлі нашай светлае імя,
Слаўся, народаў братэрскі саюз!
Наша любімая маці-Радзіма,
Вечна жыві і квітней, Беларусь!

Разам з братамі мужна вякамі
Мы баранілі родны парог,
У бітвах за волю, бітвах за долю
Свой здабывалі сцяг перамог!

Слаўся, зямлі нашай светлае імя,
Слаўся, народаў братэрскі саюз!
Наша любімая маці-Радзіма,
Вечна жыві і квітней, Беларусь!

Дружба народаў–сіла народаў–
Наш запаветны, сонечны шлях.
Горда ж узвіся ў ясныя высі,
Сцяг пераможны–радасці сцяг!

Слаўся, зямлі нашай светлае імя,
Слаўся, народаў братэрскі саюз!
Наша любімая маці-Радзіма,
Вечна жыві і квітней, Беларусь!

Государственный гимн исполняется в начале и в ряде случаев в окончании важных государственных и общественных событий.
В качестве знака выражения уважения к Государственному гимну при его официальном исполнении присутствующие слушают его стоя (мужчины - без головных уборов, военнослужащие, иные лица, для которых предусмотрено ношение форменной одежды, - в соответствии с законодательством).
       """
    },
    {
        "topic": "Административная ответственность",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
        Статья 4.2. Возраст, с которого наступает административная ответственность
1. Административной ответственности подлежит физическое лицо, достигшее ко времени совершения правонарушения возраста шестнадцати лет. Физическое лицо, совершившее правонарушение в возрасте от четырнадцати до шестнадцати лет, подлежит административной ответственности только за:
1) умышленное причинение телесного повреждения и иные насильственные действия либо нарушение защитного предписания (статья 10.1);
2) оскорбление (статья 10.2);
3) мелкое хищение (статья 11.1);
4) умышленные уничтожение либо повреждение чужого имущества (статья 11.3);
5) жестокое обращение с животным или избавление от животного (статья 16.29);
6) мелкое хулиганство (статья 19.1).
2. Не подлежит административной ответственности физическое лицо, достигшее установленного возраста административной ответственности, если будет установлено, что вследствие отставания в умственном развитии, не связанного с психическим расстройством (заболеванием), оно во время совершения деяния не могло сознавать его фактический характер и противоправность.
        Статья 10.1. Умышленное причинение телесного повреждения и иные насильственные действия либо нарушение защитного предписания
1. Умышленное причинение телесного повреждения, не повлекшего кратковременного расстройства здоровья или незначительной стойкой утраты трудоспособности, –
влечет наложение штрафа в размере от десяти до тридцати базовых величин, или общественные работы, или административный арест.
2. Нанесение побоев, не повлекшее причинения телесных повреждений, умышленное причинение боли, физических или психических страданий, совершенные в отношении близкого родственника, члена семьи или бывшего члена семьи, либо нарушение защитного предписания –
влекут наложение штрафа в размере до десяти базовых величин, или общественные работы, или административный арест.
        Статья 10.2. Оскорбление
1. Оскорбление, то есть умышленное унижение чести и достоинства личности, выраженное в неприличной форме, – влечет наложение штрафа в размере до тридцати базовых величин.
2. Оскорбление в публичном выступлении, либо в печатном или публично демонстрирующемся произведении, либо в средствах массовой информации, либо в информации, распространенной в глобальной компьютерной сети Интернет, иной сети электросвязи общего пользования или выделенной сети электросвязи, –
влечет наложение штрафа в размере от десяти до двухсот базовых величин, или общественные работы, или административный арест, а на юридическое лицо – наложение штрафа в размере от тридцати до двухсот базовых величин.
        Статья 11.1. Мелкое хищение
Мелкое хищение имущества путем кражи, мошенничества, злоупотребления служебными полномочиями, присвоения или растраты, хищения путем использования компьютерной техники, а равно попытка такого хищения –
влекут наложение штрафа в размере от двух до тридцати базовых величин, или общественные работы, или административный арест.
Примечание. Под мелким хищением в настоящей статье понимаются хищение имущества юридического лица в сумме, не превышающей десятикратного размера базовой величины, установленного на день совершения деяния, за исключением хищения ордена, медали Республики Беларусь, СССР или БССР, нагрудного знака к почетному званию Республики Беларусь, СССР или БССР, а также хищение имущества физического лица в сумме, не превышающей двукратного размера базовой величины, установленного на день совершения деяния, за исключением хищения ордена, медали Республики Беларусь, СССР или БССР, нагрудного знака к почетному званию Республики Беларусь, СССР или БССР либо хищения, совершенного группой лиц, либо путем кражи, совершенной из одежды или ручной клади, находившихся при нем, либо с проникновением в жилище.
Размер базовой величины на данный момент - 45 белорусских рублей
        Статья 11.3. Умышленные уничтожение либо повреждение чужого имущества
Умышленные уничтожение либо повреждение чужого имущества, повлекшие причинение ущерба в незначительном размере, –
влекут наложение штрафа в размере до тридцати базовых величин.
        Статья 16.29. Жестокое обращение с животным или избавление от животного
1. Жестокое обращение с животным (за исключением истязания животного), не повлекшее его гибели или увечья, –
влечет наложение штрафа в размере до пятнадцати базовых величин.
2. Избавление от животного –
влечет наложение штрафа в размере от десяти до тридцати базовых величин.
3. Жестокое обращение с животным, выразившееся в истязании животного либо повлекшее его гибель или увечье, –
влечет наложение штрафа в размере от двадцати до тридцати базовых величин, или общественные работы, или административный арест.
        Статья 19.1. Мелкое хулиганство
Оскорбительное приставание к гражданам и другие умышленные действия, нарушающие общественный порядок, деятельность организаций или спокойствие граждан и выражающиеся в явном неуважении к обществу, –
влекут наложение штрафа в размере от двух до тридцати базовых величин, или общественные работы, или административный арест.
        Статья 19.3. Распитие алкогольных, слабоалкогольных напитков или пива, потребление наркотических средств, психотропных веществ или их аналогов в общественном месте либо появление в общественном месте или на работе в состоянии опьянения
1. Распитие алкогольных, слабоалкогольных напитков или пива на улице, стадионе, в сквере, парке, общественном транспорте или в других общественных местах, кроме мест, предназначенных для употребления алкогольных, слабоалкогольных напитков или пива, либо появление в общественном месте в состоянии алкогольного опьянения, оскорбляющем человеческое достоинство и общественную нравственность, –
влекут наложение штрафа в размере до восьми базовых величин.
        Статья 19.4. Вовлечение несовершеннолетнего в антиобщественное поведение
Вовлечение несовершеннолетнего в антиобщественное поведение путем покупки для него алкогольных, слабоалкогольных напитков или пива, а также иное вовлечение лицом, достигшим возраста восемнадцати лет, заведомо несовершеннолетнего в употребление алкогольных, слабоалкогольных напитков или пива либо в немедицинское употребление сильнодействующих или других одурманивающих веществ, а равно вовлечение несовершеннолетнего в участие в собрании, митинге, уличном шествии, демонстрации, пикетировании, ином массовом мероприятии, проводимых с нарушением установленного порядка, –
влекут наложение штрафа в размере от пяти до тридцати базовых величин.
        Статья 19.6. Заведомо ложное сообщение
1. Заведомо ложное сообщение, повлекшее принятие мер реагирования милицией, скорой медицинской помощью, подразделениями по чрезвычайным ситуациям или другими специализированными службами, –
влечет наложение штрафа в размере от четырех до пятнадцати базовых величин.
2. То же действие, совершенное повторно в течение одного года после наложения административного взыскания за такое же нарушение, –
влечет наложение штрафа в размере от двадцати до тридцати базовых величин.
        """
    },
    {
        "topic": "ПДД. Общие положения и средства персональной мобильности",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
        16. Пешеход имеет право:
16.1. передвигаться по дорогам в соответствии с настоящими Правилами;
16.2. на преимущественное пересечение проезжей части дороги по нерегулируемому пешеходному переходу, а также по регулируемому пешеходному переходу при разрешающем сигнале регулировщика или светофора.
17. Пешеход обязан:
17.1. двигаться по тротуару, пешеходной дорожке, а при их отсутствии — по велосипедной дорожке, не создавая препятствия для движения велосипедистов и водителей средств персональной мобильности, либо по обочине.
В случае отсутствия указанных элементов дороги или невозможности движения пешеходов по ним допускается движение пешехода по краю ее проезжей части навстречу движению транспортных средств.
При движении по краю проезжей части дороги или обочине в темное время суток пешеход должен обозначить себя световозвращающим элементом (элементами). Световозвращающие характеристики данных элементов устанавливаются обязательными для соблюдения техническими нормативными правовыми актами;
17.2. переходить (пересекать) проезжую часть дороги по подземному, надземному пешеходным переходам, а также, убедившись, что выход на проезжую часть дороги безопасен, по наземному пешеходному переходу, а при их отсутствии в пределах видимости — на перекрестке по линии тротуаров или обочин. Выход на проезжую часть дороги должен осуществляться с разумной осмотрительностью после оценки расстояния до приближающихся транспортных средств и их скорости;
17.21. при передвижении на роликовых коньках, лыжах, другом спортивном инвентаре пересекать проезжую часть дороги со скоростью идущего шагом пешехода, убедившись, что выход (выезд) на проезжую часть дороги безопасен;
17.3. при отсутствии в пределах видимости пешехода подземного, надземного, наземного пешеходных переходов и перекрестка переходить (пересекать) проезжую часть дороги по кратчайшей траектории на участке, где дорога хорошо просматривается в обе стороны, убедившись, что выход на проезжую часть дороги безопасен и своими действиями пешеход не создаст препятствия для движения транспортных средств.
При пересечении проезжей части дороги вне подземного, надземного, наземного пешеходных переходов и перекрестка в темное время суток пешеходу рекомендуется обозначить себя световозвращающим элементом (элементами);
17.5. по требованию сотрудника ГАИ пройти в установленном порядке проверку (освидетельствование) на предмет определения состояния алкогольного опьянения либо состояния, вызванного потреблением наркотических средств, психотропных веществ, их аналогов, токсических или других одурманивающих веществ.
18. Пешеходу запрещается:
18.1. двигаться по краю проезжей части дороги при наличии тротуара, пешеходной или велосипедной дорожки, обочины, по которым возможно движение пешеходов, за исключением случаев, указанных в пунктах 21 и 135 настоящих Правил;
18.2. задерживаться и останавливаться на проезжей части дороги, в том числе на линии горизонтальной дорожной разметки, разделяющей встречные и попутные потоки транспортных средств, за исключением остановки на островках безопасности;
18.3. переходить (пересекать) проезжую часть вне подземного, надземного, наземного пешеходных переходов на участке дороги:
18.3.1. с разделительной зоной, разделительной полосой;
18.3.2. с общим числом полос движения шесть и более;
18.3.3. где установлены дорожные ограждения;
18.4. выходить на проезжую часть дороги из-за стоящего транспортного средства или иного объекта, ограничивающего обзорность дороги, не убедившись в отсутствии приближающихся транспортных средств;
18.5. исключен;
18.6. при выходе (выезде) на проезжую часть дороги и движении по ней совершать действия, угрожающие безопасности дорожного движения.
19. В темное время суток и (или) при недостаточной видимости дороги в случае движения по обочине или по краю проезжей части дороги пешеход, ведущий велосипед, средство персональной мобильности, мотоблок, мопед, мотоцикл без бокового прицепа, обозначенный габаритными огнями, сигнальными фонарями или световозвращателями (световозвращающими лентами), должен двигаться по ходу движения транспортных средств.
21. Движение организованной пешеходной колонны по проезжей части дороги разрешается только по направлению движения транспортных средств по правой стороне не более чем по четыре человека в ряд. В светлое время суток впереди и сзади с левой стороны этой колонны должны быть сопровождающие с флажками красного цвета, а в темное время суток и (или) при недостаточной видимости дороги впереди — сопровождающие с фонарем, излучающим белый свет, и сзади — излучающим красный свет.
22. Группы детей разрешается водить только по тротуарам, пешеходным и велосипедным дорожкам, а при их отсутствии — по обочинам навстречу движению транспортных средств и только в светлое время суток. При этом их передвижение осуществляется колонной не более чем по двое детей в ряд в сопровождении совершеннолетних из расчета не менее одного сопровождающего на двадцать детей.
148. Движение на велосипеде и средстве персональной мобильности должно осуществляться по велосипедной дорожке, а при ее отсутствии — по обочине, тротуару или пешеходной дорожке, не создавая препятствия для безопасного движения пешеходов. При отсутствии указанных элементов дороги или невозможности движения по ним допускается движение велосипедистов и водителей средств персональной мобильности по проезжей части дороги в один ряд не далее 1 метра от ее правого края. При этом:
148.1. выезд далее 1 метра от правого края проезжей части дороги допускается лишь для объезда препятствия и в разрешенных случаях для поворота налево или разворота;
148.2. колонны велосипедистов при движении по проезжей части дороги должны быть разделены на группы не более чем по 10 велосипедистов. Расстояние между группами должно составлять не менее 100 метров;
148.3. при наличии на проезжей части дороги линии горизонтальной дорожной разметки 1.2, обозначающей ее край, эта линия должна располагаться слева от велосипедиста.
1481. Движение велосипедистов по проезжей части вне зависимости от наличия велосипедной дорожки, обочины, тротуара или пешеходной дорожки может осуществляться:
— в зоне с ограничением максимальной скорости движения не далее 1 метра от ее правого края в один ряд;
— в ходе учебно-тренировочного процесса в случае сопровождения автомобилем прикрытия. При этом движение велосипедистов допускается в два ряда, но не более 10 велосипедистов в группе.
149. При движении по дороге в темное время суток и (или) при ее недостаточной видимости на велосипеде, средстве персональной мобильности или мопеде должны быть включены: спереди — фара (фонарь), излучающая белый свет, сзади — фонарь, излучающий красный свет. При этом вне населенных пунктов велосипедист и водитель средства персональной мобильности должны быть одеты в одежду повышенной видимости со световозвращающими элементами (за исключением движения по велосипедной дорожке).
150. Перед пересечением проезжей части велосипедист и водитель средства персональной мобильности обязаны спешиваться и переходить проезжую часть с соблюдением требований, предусмотренных пунктами 17, 18, 20, 36, 42 и 50 настоящих Правил для движения пешеходов, за исключением случаев движения:
— по велосипедному переезду при условии определения порядка проезда с использованием транспортных светофоров для регулирования движения велосипедистов;
— на перекрестке по велосипедному переезду или не далее 1 метра от правого края проезжей части дороги, когда это допускается в соответствии с пунктами 148 и 1481 настоящих Правил. При этом велосипедист и водитель средства персональной мобильности обязаны руководствоваться требованиями транспортных светофоров или регулировщика для транспортных средств, а на нерегулируемом перекрестке — правилами проезда нерегулируемых перекрестков и дорожными знаками приоритета;
— по линии тротуаров или обочин, уступая дорогу иным транспортным средствам.
151. При подъезде к пересечению с проезжей частью дороги в случае ее пересечения по велосипедному переезду, линии тротуаров или обочин велосипедист и водитель средства персональной мобильности обязаны заблаговременно снизить скорость движения и, убедившись, что выезд на проезжую часть дороги безопасен, пересекать ее со скоростью идущего шагом пешехода.
152. Движение на мопеде должно осуществляться по проезжей части дороги не далее 1 метра от ее правого края. При этом выезд далее 1 метра от ее правого края допускается лишь для объезда препятствия и для поворота налево или разворота, а также в случаях, когда полоса движения предназначена только для поворота направо.
153. Велосипедисту, водителям средства персональной мобильности и мопеда запрещается:
153.1. использовать технически неисправные велосипеды, средства персональной мобильности и мопеды, а также оборудованные с нарушением установленных требований;
153.4. двигаться по проезжей части дороги, обочине в условиях снегопада и (или) гололедицы;
153.5. перевозить пассажиров, за исключением случаев перевозки на велосипеде детей в возрасте до семи лет в велосипедном шлеме на дополнительном специально оборудованном сиденье, фиксирующем (предохраняющем) ноги ребенка, или когда перевозка пассажиров предусмотрена конструкцией мопеда;
153.6. перевозить грузы, которые выступают более чем на 0,5 метра по длине или ширине за габариты транспортного средства, а также грузы, мешающие управлению этим транспортным средством.
154. Водителю велосипеда запрещается:
— не достигнув четырнадцати лет, управлять велосипедом на дороге без сопровождения совершеннолетнего лица (кроме пешеходных и жилых зон, тротуаров, велосипедных и пешеходных дорожек);
— поворачивать налево или разворачиваться на дороге, имеющей трамвайный путь, и на дороге, имеющей более одной полосы для движения в данном направлении.
155. Водителю мопеда запрещается ездить по тротуарам, велосипедным и пешеходным дорожкам, дорожкам для всадников.
156. Запрещается буксировка средства персональной мобильности и средством персональной мобильности, а также велосипеда и велосипедом, за исключением велосипедного прицепа промышленного производства.
1561. Водителю средства персональной мобильности запрещается:
— двигаться в населенном пункте со скоростью более 10 км/ч, за исключением движения по велосипедным дорожкам или проезжей части дороги, когда это допускается в соответствии с пунктом 148 настоящих Правил;
— не достигнув четырнадцати лет, управлять средством персональной мобильности на дороге без сопровождения совершеннолетнего лица (за исключением жилых зон);
— двигаться в пешеходной зоне;
— поворачивать налево или разворачиваться на дороге, имеющей трамвайный путь, и на дороге, имеющей более одной полосы для движения в данном направлении;
— двигаться по тротуару, если масса средства персональной мобильности превышает 35 кг;
— оставлять средства персональной мобильности в местах, где это создает препятствия для движения иных участников дорожного движения.
1562. Водителю средства персональной мобильности рекомендуется использовать во время движения шлем."""
    },
    {
        "topic": "Трудоустройство",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
        Статья 18. Форма трудового договора
Трудовой договор заключается в письменной форме, составляется в двух экземплярах. Каждая страница трудового договора и приложений к нему нумеруется и подписывается работником и нанимателем либо уполномоченным им должностным лицом. Один экземпляр трудового договора передается работнику, другой хранится у нанимателя.
Примерная форма трудового договора утверждается Правительством Республики Беларусь или уполномоченным им органом
        Статья 20. Запрещение требовать выполнения работы, не обусловленной трудовым договором
Наниматель не вправе требовать от работника выполнения работы, не обусловленной трудовым договором, за исключением случаев, предусмотренных законодательными актами.
        Статья 21. Возраст, с которого допускается заключение трудового договора
Заключение трудового договора допускается с лицами, достигшими шестнадцати лет.
С письменного согласия одного из родителей (усыновителей (удочерителей), попечителей) трудовой договор может быть заключен с лицом, достигшим четырнадцати лет, с соблюдением условий, предусмотренных статьей 272 настоящего Кодекса.
        Статья 114. Сокращенная продолжительность рабочего времени для отдельных категорий работников
Для работников моложе восемнадцати лет устанавливается сокращенная продолжительность рабочего времени: в возрасте от четырнадцати до шестнадцати лет – не более 23 часов в неделю, от шестнадцати до восемнадцати лет – не более 35 часов в неделю.
Продолжительность рабочего времени учащихся, получающих общее среднее, профессионально-техническое образование, специальное образование на уровне общего среднего образования, работающих в свободное от учебы время в течение учебного года, за исключением каникул, не может превышать половины максимальной продолжительности рабочего времени, предусмотренной частью первой настоящей статьи для лиц соответствующего возраста.
Инвалидам I и II группы устанавливается сокращенная продолжительность рабочего времени не более 35 часов в неделю.
Продолжительность рабочего времени для работающих на территории радиоактивного загрязнения в зоне эвакуации (отчуждения), в том числе временно направленных или командированных в эти зоны, не может превышать 35 часов в неделю.
Для отдельных категорий работников (учителя, врачи и др.) сокращенная продолжительность рабочего времени устанавливается Правительством Республики Беларусь или уполномоченным им органом.
        Статья 115. Нормирование продолжительности ежедневной работы (смены)
Продолжительность ежедневной работы (смены) определяется правилами внутреннего трудового распорядка или графиком работ (сменности) с соблюдением нормы продолжительности рабочей недели, установленной нанимателем в соответствии со статьями 112–114 настоящего Кодекса.
Продолжительность ежедневной работы (смены) не может превышать:
1) для работников в возрасте от четырнадцати до шестнадцати лет – 4 часа 36 минут, от шестнадцати до восемнадцати лет – семь часов;
2) для учащихся, получающих общее среднее, профессионально-техническое образование, специальное образование на уровне общего среднего образования, работающих в свободное от учебы время в течение учебного года, за исключением каникул, в возрасте от четырнадцати до шестнадцати лет – 2 часа 18 минут, в возрасте от шестнадцати до восемнадцати лет – 3 часа 30 минут;
        Статья 272. Возраст, с которого допускается заключение трудового договора
Заключение трудового договора допускается с лицами, достигшими шестнадцати лет.
С письменного согласия одного из родителей (усыновителей (удочерителей), попечителей) трудовой договор может быть заключен с лицом, достигшим четырнадцати лет, для выполнения легкой работы или занятия профессиональным спортом, которые:
1) не являются вредными для его здоровья и развития;
2) не препятствуют получению общего среднего, профессионально-технического и среднего специального образования.
Перечень легких видов работ, которые могут выполнять лица в возрасте от четырнадцати до шестнадцати лет, утверждается республиканским органом государственного управления, проводящим государственную политику в области труда.
        Статья 273. Права несовершеннолетних в трудовых правоотношениях
Несовершеннолетние (лица, не достигшие восемнадцати лет) в трудовых правоотношениях приравниваются в правах к совершеннолетним, а в области охраны труда, рабочего времени, отпусков и некоторых других условий труда пользуются гарантиями, установленными настоящим Кодексом, иными актами законодательства, коллективными договорами, соглашениями.
        Статья 274. Работы, на которых запрещается привлечение к труду лиц моложе восемнадцати лет
Запрещается привлечение к труду лиц моложе восемнадцати лет на тяжелых работах и на работах с вредными и (или) опасными условиями труда, на подземных и горных работах.
Список работ, на которых запрещается привлечение к труду лиц моложе восемнадцати лет, утверждается республиканским органом государственного управления, проводящим государственную политику в области труда.
Запрещаются подъем и перемещение несовершеннолетними тяжестей вручную, превышающих установленные для них предельные нормы, если иное не установлено настоящим Кодексом. Предельные нормы подъема и перемещения несовершеннолетними тяжестей вручную устанавливаются республиканским органом государственного управления, проводящим государственную политику в области здравоохранения.
        Статья 275. Медицинские осмотры лиц моложе восемнадцати лет
Все лица моложе восемнадцати лет принимаются на работу лишь после предварительного медицинского осмотра и в дальнейшем, до достижения восемнадцати лет, ежегодно подлежат обязательному медицинскому осмотру, если иное не установлено настоящим Кодексом.
Обязательные ежегодные медицинские осмотры несовершеннолетних работников проводятся в рабочее время с сохранением среднего заработка.
        Статья 276. Запрещение привлекать работников моложе восемнадцати лет к ночным и сверхурочным работам, работам в государственные праздники, праздничные и выходные дни
Запрещается привлекать работников моложе восемнадцати лет к ночным и сверхурочным работам, работам в государственные праздники и праздничные дни (часть первая статьи 147), работам в выходные дни, если иное не установлено настоящим Кодексом.
        Статья 277. Трудовые отпуска работникам моложе восемнадцати лет
Трудовые отпуска работникам моложе восемнадцати лет предоставляются в летнее время или, по их желанию, в любое другое время года.
        Статья 278. Нормы выработки для молодых работников
Для работников моложе восемнадцати лет нормы выработки устанавливаются исходя из норм выработки для взрослых работников пропорционально сокращенной продолжительности рабочего времени, предусмотренного законодательством для данной категории работников.
Для работников, принимаемых на работу после получения общего среднего образования, специального образования на уровне общего среднего образования, профессионально-технического и среднего специального образования, прошедших обучение непосредственно на производстве, могут устанавливаться пониженные нормы выработки. Размеры пониженных норм и сроки их действия определяются в коллективном договоре.
        Статья 279. Оплата труда работников моложе восемнадцати лет при сокращенной продолжительности ежедневной работы
Оплата труда работников моложе восемнадцати лет при сокращенной продолжительности ежедневной работы производится в таком же размере, как оплата труда работников соответствующих категорий при полной продолжительности ежедневной работы.
Труд работников моложе восемнадцати лет, допущенных к сдельным работам, оплачивается по сдельным расценкам, установленным для взрослых работников, с доплатой по тарифной ставке (тарифному окладу), окладу за время, на которое продолжительность их ежедневной работы сокращается по сравнению с продолжительностью ежедневной работы взрослых работников.
Оплата труда учащихся, получающих общее среднее образование, специальное образование на уровне общего среднего образования, профессионально-техническое и среднее специальное образование, работающих в свободное от учебы время, производится пропорционально отработанному времени или в зависимости от выработки. Нанимателями могут устанавливаться учащимся доплаты к заработной плате.
        Статья 280. Броня приема молодежи на работу, броня для трудоустройства выпускников
Местными исполнительными и распорядительными органами организациям устанавливаются броня приема на работу для лиц в возрасте до 21 года, впервые ищущих работу, лиц из числа детей-сирот и детей, оставшихся без попечения родителей, а также броня для трудоустройства выпускников, получивших профессионально-техническое, среднее специальное и высшее образование, относящихся к категориям детей-сирот и детей, оставшихся без попечения родителей, лиц из числа детей-сирот и детей, оставшихся без попечения родителей, лиц с особенностями психофизического развития, которым выдано свидетельство о направлении на работу.
        Статья 281. Предоставление первого рабочего места
Выпускникам государственных учреждений образования, получившим профессионально-техническое, среднее специальное и высшее образование, которым место работы предоставлено путем распределения, выпускникам, получившим профессионально-техническое, среднее специальное и высшее образование, относящимся к категориям детей-сирот и детей, оставшихся без попечения родителей, лиц из числа детей-сирот и детей, оставшихся без попечения родителей, лиц с особенностями психофизического развития, которым место работы предоставлено путем трудоустройства в счет брони, лицам с особенностями психофизического развития, получившим специальное образование на уровне общего среднего образования, военнослужащим срочной военной службы, уволенным из Вооруженных Сил Республики Беларусь, других войск и воинских формирований, а также гражданам, уволенным с альтернативной службы, гарантируется предоставление первого рабочего места. Порядок и условия предоставления первого рабочего места указанным лицам определяются Правительством Республики Беларусь.
Первым рабочим местом считается место работы, предоставляемое:
выпускникам государственных учреждений образования, которым место работы предоставлено путем распределения, если до поступления в учреждение образования они не состояли в трудовых отношениях;
выпускникам, получившим профессионально-техническое, среднее специальное и высшее образование, относящимся к категориям детей-сирот и детей, оставшихся без попечения родителей, лиц из числа детей-сирот и детей, оставшихся без попечения родителей, лиц с особенностями психофизического развития, которым место работы предоставлено путем трудоустройства в счет брони, если до поступления в учреждение образования они не состояли в трудовых отношениях;
лицам с особенностями психофизического развития, получившим специальное образование на уровне общего среднего образования, если они не состояли в трудовых отношениях;
военнослужащим срочной военной службы, уволенным из Вооруженных Сил Республики Беларусь, других войск и воинских формирований, гражданам, уволенным с альтернативной службы, если на момент призыва на срочную службу, направления на альтернативную службу они не состояли в трудовых отношениях.
        Статья 282. Дополнительные гарантии работникам моложе восемнадцати лет при расторжении трудового договора по инициативе нанимателя
Расторжение трудового договора с работниками моложе восемнадцати лет по основаниям, предусмотренным пунктами 1–5 статьи 42 настоящего Кодекса, допускается, помимо соблюдения общего порядка, только с согласия, а по основаниям, предусмотренным пунктами 6–11 статьи 42 и пунктами 2 и 3 статьи 44 настоящего Кодекса, – после предварительного, не менее чем за две недели, уведомления районной (городской) комиссии по делам несовершеннолетних, если иное не установлено настоящим Кодексом.

"""
    }
]

def get_prompt_for_type(q_type, topic, legal_text, count_needed):

    base_role = f"""
    РОЛЬ: Ты педагог для детей 8-12 лет. Ты создаешь викторину по теме "{topic}".
    ИСТОЧНИК (Закон): "{legal_text}..."
    ЗАДАЧА: Сгенерируй {count_needed} вопросов в формате JSON.
    ЯЗЫК: Русский. Простой, понятный детям. Без канцеляризмов ("данное лицо", "осуществляет").
    ПОДСКАЗКА (hint): Должна сильно помогать в нахождении ответа, но не раскрывать его.
    """

    type_instructions = {
        "single": """
        ТИП: Одиночный выбор (single).
        ТРЕБОВАНИЯ:
        1. Ситуация должна быть жизненной (школа, улица, дом).
        2. "options": 4 варианта. Только 1 правильный.
        3. Неправильные ответы должны быть: смешными, опасными, абсурдными или с типичными детскими ошибками.
        ШАБЛОН JSON:
        {
            "type": "single",
            "question": "Текст вопроса?",
            "options": ["Неверно", "Верно", "Неверно", "Неверно"],
            "correct": 1,
            "hint": "Подсказка"
        }
        """,

        "multiple": """
        ТИП: Множественный выбор (multiple).
        КРИТИЧЕСКИ ВАЖНО:
        1. В поле "correct" ДОЛЖНО быть МИНИМУМ 2 индекса (например, [0, 2] или [1, 3, 0]).
        2. Вопрос должен подразумевать несколько действий (например, "Что МОЖНО делать?").
        3. Если правильный ответ только один — это ошибка генерации.
        4. Неправильные ответы должны быть: смешными, опасными, абсурдными или с типичными детскими ошибками.
        ШАБЛОН JSON:
        {
            "type": "multiple",
            "question": "Выберите ВСЕ правильные действия:",
            "options": ["Правильно 1", "Опасно", "Правильно 2", "Глупо"],
            "correct": [0, 2],
            "hint": "Подсказка"
        }
        """,

        "matching": """
        ТИП: Соедини пары (matching).
        ТРЕБОВАНИЯ:
        1. Логика должна быть "железобетонной". Не должно быть так, что вариант А подходит и к 1, и к 2.
        2. Используй связи: "Нарушение -> Наказание", "Знак -> Значение", "Действие -> Последствие" и так далее.
        3. 3 или 4 пары.
        ШАБЛОН JSON:
        {
            "type": "matching",
            "question": "Соедини символы и их значения",
            "leftItems": ["Символ 1", "Символ 2"],
            "rightItems": ["Значение 1", "Значение 2"],
            "correctPairs": {
                "Символ 1": "Значение 1",
                "Символ 2": "Значение 2"
            },
            "hint": "Подсказка"
        }
        """,

        "sequence": """
        ТИП: Восстанови порядок (sequence).
        КРИТИЧЕСКИ ВАЖНО:
        1. Шаги должны быть ФИЗИЧЕСКИМИ и НЕОБРАТИМЫМИ во времени. 
        2. ПЛОХО: "Подумать" -> "Решить" (это происходит в голове, дети путаются).
        3. ХОРОШО: "Подойти к переходу" -> "Посмотреть по сторонам" -> "Пойти" (нельзя пойти, не подойдя).
        4. Если шаги можно поменять без потери смысла - вопрос некорректен.
        5. От 3 до 5 шагов.
        6. Генерируй простые вопросы, насколько это возможно
        ШАБЛОН JSON:
        {
            "type": "sequence",
            "question": "Расставь действия по порядку",
            "steps": ["Шаг 2", "Шаг 1", "Шаг 3"],
            "correctOrder": [1, 0, 2],
            "hint": "Подсказка"
        }
        """,

        "find-error": """
        ТИП: Найди ошибку (find-error).
        ТРЕБОВАНИЯ:
        1. Дается список правил, действий или фактов. Одно из них — НЕВЕРНОЕ, ОПАСНОЕ или ПРОТИВОЗАКОННОЕ.
        2. Это не должна быть орфографическая ошибка. Это ошибка поведения.
        3. Неправильный ответ должен быть: смешным, опасным, абсурдным или с типичными детскими ошибками.
        4. Остальные варианты - абсолютно верные
        ШАБЛОН JSON:
        {
            "type": "find-error",
            "question": "Найди лишнее",
            "code": [
                "Верно 1",
                "Верно 2",
                "Неверно"
            ],
            "errorLine": 2,
            "hint": "Подсказка"
        }
        """,

        "fill-blanks": """
        ТИП: Вставь пропущенное слово (fill-blanks).
        ТРЕБОВАНИЯ:
        1. Предложение из закона, но максимально упрощенное.
        2. Пропущено КЛЮЧЕВОЕ слово.
        3. В options даются варианты этого слова.
        4. Неправильные ответы должны быть: смешными, опасными, абсурдными или с типичными детскими ошибками.
        ШАБЛОН JSON:
        {
            "type": "fill-blanks", 
            "question": "Заполни пропуски в тексте",
            "code": "Текст до <span class=\\"blank\\" data-id=\\"1\\">______</span> текст между <span class=\\"blank\\" data-id=\\"2\\">______</span> текст после.",
            "blanks": {
                "1": ["правильный1", "неверный1", "неверный2"],
                "2": ["неверный1", "правильный2"]
            },
            "correct": ["правильный1", "правильный2"],
            "hint": "Подсказка по смыслу пропущенных слов"
        }
        """
    }

    specific_instr = type_instructions.get(q_type, type_instructions['single'])

    full_prompt = f"""
    {base_role}

    {specific_instr}

    ВЫВОД: Только валидный JSON массив объектов [{count_needed} шт]. Без лишнего текста.
    """
    return full_prompt


def load_existing_questions():
    """Загружает существующие вопросы и считает статистику."""
    if not os.path.exists(OUTPUT_FILE):
        return [], {}

    try:
        with open(OUTPUT_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)

        stats = {}
        for q in data:
            t = q.get('theme', 'Unknown')
            qt = q.get('type', 'unknown')
            if t not in stats: stats[t] = {}
            if qt not in stats[t]: stats[t][qt] = 0
            stats[t][qt] += 1

        return data, stats
    except Exception as e:
        logger.error(f"Ошибка чтения файла {OUTPUT_FILE}: {e}")
        return [], {}


def extract_json_from_text(text: str):
    """Надежный парсер JSON из ответа LLM."""
    try:
        # Пытаемся найти массив
        match = re.search(r'\[.*\]', text, re.DOTALL)
        if match: return json.loads(match.group(0))
        # Пытаемся найти одиночный объект
        match_obj = re.search(r'\{.*\}', text, re.DOTALL)
        if match_obj: return [json.loads(match_obj.group(0))]
        return None
    except:
        return None


def validate_question(q):
    """Строгая валидация."""
    try:
        if not isinstance(q, dict): return False
        if len(q.get('question', '')) > 300: return False  # Слишком длинно

        q_type = q.get('type')

        # Валидация Multiple
        if q_type == 'multiple':
            if not isinstance(q.get('correct'), list) or len(q['correct']) < 2:
                logger.warning(f"⚠️ Multiple должен иметь >= 2 ответов: {q['question']}")
                return False

        # Валидация Sequence
        if q_type == 'sequence':
            steps = q.get('steps', [])
            if len(steps) < 3: return False
            if len(set(steps)) != len(steps): return False  # Дубликаты

        # Валидация индексов (общая)
        if 'options' in q and isinstance(q['correct'], int):
            if q['correct'] >= len(q['options']) or q['correct'] < 0: return False

        return True
    except Exception as e:
        logger.error(f"Validation Error: {e}")
        return False


def generate_batch(topic, q_type, legal_text, count_needed):
    """Генерирует партию вопросов."""
    # Ограничиваем запрос, чтобы не просить слишком много за раз (макс BATCH_SIZE)
    request_count = min(count_needed, BATCH_SIZE)

    prompt = get_prompt_for_type(q_type, topic, legal_text, request_count)

    headers = {"Authorization": f"Bearer {GROQ_API_KEY}", "Content-Type": "application/json"}
    data = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": "You are a helpful JSON generator assistant. Output ONLY JSON."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.4  # Чуть повыше, чтобы вопросы были разнообразнее, но не бред
    }

    try:
        response = requests.post(GROQ_API_URL, headers=headers, json=data)

        if response.status_code == 429:
            logger.warning("⏳ Rate Limit 429. Ждем 15 сек...")
            time.sleep(15)
            return []

        if response.status_code != 200:
            logger.error(f"API Error {response.status_code}: {response.text}")
            return []

        content = response.json()['choices'][0]['message']['content']
        result_json = extract_json_from_text(content)

        valid_batch = []
        if result_json:
            for q in result_json:
                if validate_question(q):
                    q['theme'] = topic
                    # Создаем уникальный ID
                    uniq_str = f"{topic}_{q['question']}"
                    q['id'] = hashlib.md5(uniq_str.encode()).hexdigest()
                    valid_batch.append(q)

        return valid_batch

    except Exception as e:
        logger.error(f"Exception during generation: {e}")
        return []


def main():
    if not CONTEXT_REGISTRY:
        logger.error("Нет данных в CONTEXT_REGISTRY")
        return

    # 1. Загружаем текущее состояние
    all_questions, stats = load_existing_questions()
    logger.info(f"📂 Загружено {len(all_questions)} вопросов. Анализ недостающих...")

    total_added = 0

    # 2. Проходим по темам и типам
    for context in CONTEXT_REGISTRY:
        topic = context['topic']
        legal_text = context['legal_text']

        logger.info(f"--- Тема: {topic} ---")

        for q_type in context['q_types']:
            # Сколько уже есть?
            current_count = stats.get(topic, {}).get(q_type, 0)
            needed = TARGET_PER_TYPE - current_count

            if needed <= 0:
                logger.info(f"✅ {q_type}: уже есть {current_count} (Цель: {TARGET_PER_TYPE}). Пропуск.")
                continue

            logger.info(f"🔄 {q_type}: есть {current_count}. Нужно еще {needed}. Генерируем...")

            # Генерируем пока не заполним квоту (или пока не упремся в лимиты цикла)
            attempts = 0
            while needed > 0 and attempts < 3:
                new_questions = generate_batch(topic, q_type, legal_text, needed)

                # Фильтруем дубликаты (по ID), если вдруг API вернул то же самое
                existing_ids = {q['id'] for q in all_questions}
                unique_new = [q for q in new_questions if q['id'] not in existing_ids]

                if unique_new:
                    all_questions.extend(unique_new)
                    total_added += len(unique_new)
                    needed -= len(unique_new)
                    logger.info(f"   + Добавлено {len(unique_new)} вопросов.")
                else:
                    logger.warning("   ⚠️ Пустая или дублирующая генерация.")

                attempts += 1
                time.sleep(BASE_DELAY)  # Пауза между запросами

            # Промежуточное сохранение после каждого типа вопросов
            with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                json.dump(all_questions, f, ensure_ascii=False, indent=2)

    logger.info(f"🎉 Готово! Всего добавлено в этой сессии: {total_added}. Всего в файле: {len(all_questions)}")


if __name__ == "__main__":
    main()