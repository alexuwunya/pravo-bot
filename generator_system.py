import os
import json
import requests
import time
import logging
import hashlib
import re
from dotenv import load_dotenv

# --- НАСТРОЙКИ ---
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
load_dotenv()

GROQ_API_KEY = os.getenv('GROQ_API_KEY')
if not GROQ_API_KEY:
    logger.critical("❌ GROQ_API_KEY не найден!")
    exit(1)

GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions"
MODEL = "llama-3.3-70b-versatile"
OUTPUT_FILE = "html/questions.json"

MAX_RETRIES = 3
BASE_DELAY = 5
# Сколько вопросов КАЖДОГО типа мы хотим иметь в итоге по каждой теме
TARGET_PER_TYPE = 5
BATCH_SIZE = 5  # Сколько запрашиваем у нейросети за один раз

CONTEXT_REGISTRY = [
    {
        "topic": "Государственные символы",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 1. Три главных символа страны Текст: У Республики Беларусь, как у любого независимого государства, есть три главных символа: Государственный флаг, Государственный герб и Государственный гимн. Ключевые слова: символы, флаг, герб, гимн, независимость.
Статья 2. Обязанность уважать символы Текст: Все граждане Беларуси, а также гости из других стран, обязаны относиться к флагу, гербу и гимну с уважением. Это значит, что нельзя их портить, пачкать или смеяться над ними. Ключевые слова: уважение, обязанность, граждане, гости.
Статья 4. Как выглядит наш флаг Текст: Флаг Беларуси — это прямоугольное полотнище, которое состоит из трех частей. Сверху — широкая красная полоса, снизу — зеленая полоса (она уже, чем красная). Сбоку, у самого древка (палки, на которой держится флаг), расположен красный белорусский узор (орнамент) на белом фоне. Ключевые слова: описание флага, красный, зеленый, орнамент, узор.
Статья 5. Где можно увидеть флаг Текст: Флаг всегда висит над важными зданиями (например, над школами и университетами). Также его поднимают на стадионах во время соревнований и праздников. Обычные люди тоже могут использовать флаг во время семейных или народных праздников, и даже поставить маленький флажок у себя на столе, главное — делать это с уважением. Ключевые слова: школа, праздник, стадион, настольный флажок, использование.
Статья 6. Если флагов несколько Текст: Если наш флаг висит рядом с флагом другой страны, то белорусский флаг должен находиться справа (если стоять к ним лицом). Наш флаг не должен быть меньше по размеру или висеть ниже, чем флаги других стран. Ключевые слова: другие страны, правила размещения, этикет.
Статья 7. Флаг в дни траура Текст: В грустные дни (дни траура) к флагу прикрепляют черную ленту. Если флаг висит на флагштоке (высоком столбе), его немного приспускают вниз в знак печали. Ключевые слова: траур, черная лента, память, печаль.
Статья 8. Изображение флага на вещах Текст: Красивое изображение флага можно использовать для украшения, если это не выглядит обидно для символа. Но запомни важное правило: на самом флаге нельзя ничего писать или рисовать. Ключевые слова: рисунки, украшение, запрет надписей, сувениры.
Статья 81 (8.1). Старые и рваные флаги Текст: Нельзя вывешивать флаг, если он порвался, выцвел или стал грязным. Такой испорченный флаг нужно заменить на новый. Ключевые слова: старый флаг, замена, чистота, порядок.
Статья 9. Как выглядит наш герб Текст: На гербе Беларуси изображен золотой контур нашей страны в лучах восходящего солнца. Сверху — красная звезда. Герб окружен венком из колосков пшеницы, цветов клевера и льна. Венок перевязан красно-зеленой лентой, на которой золотыми буквами написано «Рэспубліка Беларусь». Ключевые слова: описание герба, солнце, колосья, клевер, лен, надпись.
Статья 10. Где встречается герб Текст: Герб можно увидеть на самых важных документах: на паспорте, на деньгах (купюрах и монетах), на школьном аттестате и на медалях за отличную учебу. Также он есть на печатях государственных учреждений. Использовать герб на визитках обычных людей нельзя. Ключевые слова: паспорт, деньги, аттестат, медаль, печать.
Статья 11. Что такое гимн Текст: Гимн — это главная музыкальная песня страны. Его могут петь хором, играть на инструментах или транслировать по радио и телевизору. Ключевые слова: музыка, песня, исполнение.
Статья 12. Когда звучит гимн Текст: Гимн исполняют на торжественных линейках в школе (в начале и конце учебного года), на важных спортивных соревнованиях и государственных праздниках. Также его можно услышать по радио и телевизору каждый день утром (в 6:00) и в полночь. В Новогоднюю ночь гимн звучит сразу после боя часов. Ключевые слова: школа, линейка, радио, Новый год, спорт.
Статья 13. Как вести себя, когда звучит гимн Текст: Когда играет гимн, нужно обязательно встать и слушать его стоя. Мальчики и мужчины должны снять головные уборы (шапки, кепки). Если рядом поднимают флаг, нужно повернуться к нему лицом. Ключевые слова: поведение, стоять смирно, снять шапку, этикет.
Статья 15. Наказание за неуважение Текст: Тот, кто специально портит символы страны или издевается над ними, будет наказан по закону. Ключевые слова: наказание, закон, ответственность, нарушение.        
        """
    },
    {
        "topic": "Административная ответственность",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 4.2. С какого возраста могут наказать
Текст: Обычно за административные нарушения (проступки) ты отвечаешь сам, если тебе уже исполнилось **16 лет**. Но есть серьезные нарушения, за которые наказывают уже с **14 лет**. Это, например, драки, воровство, хулиганство или жестокость к животным. Если тебе еще нет 14 или 16 лет, за твои поступки будут отвечать твои родители.
Ключевые слова: возраст, 14 лет, 16 лет, ответственность, наказание.
---
Статья 9.1. Наказание для подростков
Текст: Если ты совершил нарушение в возрасте от 14 до 18 лет, к тебе применяются особые правила. Тебя не могут отправить на общественные работы или посадить под арест так же строго, как взрослых. Чаще всего применяются меры воспитания (предупреждения, извинения).
Ключевые слова: подростки, несовершеннолетние, особые правила.
---
Статья 9.4. Воспитательные меры (вместо штрафа)
Текст: Если ты провинился, но хочешь исправиться, вместо строгого наказания тебе могут назначить "урок":
1. Объяснят закон (расскажут, почему так делать нельзя).
2. Попросят извиниться перед тем, кого ты обидел (публично или лично).
3. Заставят исправить то, что ты сломал (например, отмыть парту или заклеить книгу).
4. Ограничат твои развлечения (запретят гулять поздно вечером или посещать определенные места).
Ключевые слова: извинения, исправление вреда, воспитание, запрет на гуляние.
---
Статья 11.1. Мелкое воровство
Текст: Нельзя брать чужие вещи без спроса, даже если они стоят недорого. Если ты украл что-то в магазине или у друга (например, шоколадку, значок, ручку), это считается мелким хищением. За это могут оштрафовать или заставить выполнять полезную работу.
Ключевые слова: воровство, кража, чужие вещи, магазин.
---
Статья 11.3. Порча чужих вещей
Текст: Если ты специально сломал, разбил или испортил чужую вещь (например, разбил мячом окно, поцарапал чужую машину или сломал скамейку в парке), это нарушение. Придется отвечать за свои действия.
Ключевые слова: вандализм, сломал, испортил, разбил, чужое имущество.
---
Статья 11.4. Присвоение находки
Текст: Если ты нашел на улице телефон, кошелек или другую ценную вещь и не попытался вернуть её владельцу или отнести в милицию/родителям, а оставил себе — это считается нарушением. Найденное — не значит твоё.
Ключевые слова: находка, нашел телефон, потерянные вещи, клад.
---
Статья 16.29. Жестокость к животным
Текст: Запрещено обижать животных: бить их, мучить или выгонять из дома на улицу. Если ты плохо обращаешься с питомцами или бездомными животными, за это строго накажут. Животные нуждаются в защите.
Ключевые слова: животные, собаки, кошки, жестокость, защита животных.
---
Статья 18.8. Мусор из окна машины
Текст: Нельзя выбрасывать фантики, бутылки и любой другой мусор из окон автомобиля или автобуса. Также запрещено открывать двери машины, пока она едет.
Ключевые слова: мусор, автомобиль, транспорт, безопасность.
---
Статья 18.28. Безбилетный проезд ("Заяц")
Текст: В автобусе, троллейбусе, трамвае или метро нужно обязательно платить за проезд. Если ты едешь без билета или проездного, тебя могут оштрафовать.
Ключевые слова: билет, проезд, заяц, контролер, транспорт.
---
Статья 19.1. Мелкое хулиганство
Текст: Нельзя вести себя вызывающе в общественных местах: громко ругаться плохими словами, приставать к прохожим, мешать другим людям отдыхать или работать. Это считается неуважением к окружающим и называется хулиганством.
Ключевые слова: хулиганство, ругань, плохое поведение, улица.
---
Статья 19.3. Алкоголь в общественных местах
Текст: Запрещено пить пиво или другие алкогольные напитки на улице, в парке, на стадионе или в подъезде. Также нельзя появляться в таких местах пьяным — это оскорбляет других людей.
Ключевые слова: алкоголь, пиво, улица, парк, запрет.
---
Статья 19.6. Ложный вызов
Текст: Нельзя звонить в милицию (102), скорую (103) или пожарным (101) ради шутки. Если ты обманул спасателей и сказал, что где-то пожар или беда, а на самом деле всё хорошо — это серьезное нарушение. Специальные службы могут не успеть к тем, кому нужна реальная помощь.
Ключевые слова: ложный вызов, шутка, телефон, 101, 102, 103.
---
Статья 19.9. Курение где попало
Текст: Курить (в том числе электронные сигареты и вейпы) можно только в специальных местах. Если ты куришь на остановке, в школе или на детской площадке — это нарушение закона.
Ключевые слова: курение, сигареты, вейп, школа, запрет.
---
Статья 24.42. Купание в запрещенных местах
Текст: Купаться можно только там, где есть пляж и спасатели. Если ты полезешь в воду там, где стоит знак "Купание запрещено" (например, в техническом пруду, у дамбы или в грязной реке), тебя могут наказать, потому что это опасно для жизни.
Ключевые слова: река, озеро, пляж, купание запрещено, вода.
        """
    },
    {
        "topic": "ПДД",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 2. Кто есть кто на дороге (Основные понятия)
Текст: Давай разберемся с главными участниками движения:
1. **Пешеход** — это человек, который идет пешком. К пешеходам относятся и те, кто едет на роликах, самокате (обычном, без мотора), лыжах или везет велосипед в руках.
2. **Водитель** — тот, кто управляет машиной, автобусом или мотоциклом.
3. **Средство персональной мобильности (СПМ)** — это электросамокаты, гироскутеры и моноколеса. Если ты едешь на таком устройстве, ты приравниваешься к пешеходу, но должен соблюдать особые правила.
4. **Фликер (световозвращающий элемент)** — значок или лента, которая светится в свете фар. Это твой главный защитник в темноте!
Ключевые слова: пешеход, водитель, самокат, СПМ, фликер, определения.
---
Статья 17.1. Где можно ходить пешеходу
Текст: Пешеходы должны ходить только по **тротуарам** или пешеходным дорожкам. Если их нет — можно идти по обочине. В самом крайнем случае, если нет ни тротуара, ни обочины, можно идти по краю дороги, но обязательно **навстречу машинам** (чтобы видеть опасность лицом к лицу).
Ключевые слова: тротуар, обочина, движение пешеходов, правила ходьбы.
---
Статья 17.1 (часть 2). Правило "светлячка" (Фликеры)
Текст: Если на улице темно (вечер или ночь), и ты идешь по краю дороги или обочине, ты **обязан** обозначить себя фликером (световозвращающим элементом). Водитель заметит тебя издалека и успеет затормозить.
Ключевые слова: фликер, темнота, ночь, безопасность, видимость.
---
Статья 17.2. Как переходить дорогу
Текст: Переходи дорогу только в специальных местах:
1. По подземному переходу (самый безопасный вариант).
2. По "зебре" (наземный переход).
3. Если перехода нет рядом — на перекрестке по линии тротуаров.
Перед выходом на дорогу **всегда остановись**, посмотри по сторонам, убедись, что машины остановились и пропускают тебя. Нельзя выбегать на дорогу внезапно!
Ключевые слова: переход дороги, зебра, безопасность, подземный переход.
---
Статья 18. Чего нельзя делать пешеходу
Текст:
1. Нельзя ходить по краю дороги, если рядом есть тротуар.
2. Нельзя останавливаться или играть на проезжей части.
3. Нельзя переходить дорогу там, где есть заборчики (ограждения) или разделительная полоса.
4. Нельзя выходить на дорогу из-за стоящего автобуса или машины, не осмотревшись — водитель может тебя не заметить.
Ключевые слова: запреты, игра на дороге, опасность, выход из-за автобуса.
---
Статья 20. Сирены и мигалки
Текст: Если ты видишь машину с включенными синими или красными маячками (полиция, скорая, пожарная) и слышишь сирену — **не переходи дорогу**! Если ты уже на дороге — быстро уйди с нее. Этим машинам нужно ехать очень быстро, чтобы кого-то спасти.
Ключевые слова: скорая помощь, полиция, сирена, мигалки, спецтранспорт.
---
Статья 23. Правила для пассажира
Текст: Когда ты едешь в машине:
1. Всегда пристегивайся ремнем безопасности (или сиди в детском кресле, если ты еще маленький).
2. Садись в машину и выходи из нее только со стороны тротуара, когда машина полностью остановилась.
3. Не отвлекай водителя разговорами и не мешай ему вести машину.
4. Не высовывай руки и голову в окно.
Ключевые слова: пассажир, ремень безопасности, автомобиль, поведение в машине.
---
Статья 39-42. Светофор
Текст:
* **Зеленый:** Можно идти (или ехать). Но все равно посмотри по сторонам!
* **Зеленый мигающий:** Время заканчивается, лучше остановиться и не начинать переход.
* **Желтый:** Внимание, скоро будет красный. Идти нельзя.
* **Красный:** Стой! Движение запрещено. Даже если машин нет, переходить на красный нельзя.
Ключевые слова: светофор, красный свет, зеленый свет, сигналы.
---
Статья 148. Где кататься на велосипеде и электросамокате
Текст: На велосипеде и электросамокате (СПМ) нужно ездить по **велосипедной дорожке**. Если её нет — можно ехать по тротуару, но аккуратно, чтобы не мешать пешеходам. Выезжать на дорогу можно только в крайнем случае, если нет ни велодорожки, ни тротуара, и только не дальше 1 метра от края (справа).
Ключевые слова: велосипед, самокат, велодорожка, тротуар.
---
Статья 149. Велосипед в темноте
Текст: Если ты едешь на велосипеде или самокате вечером:
1. Спереди должен гореть белый фонарь.
2. Сзади — красный фонарь.
3. Если едешь не по велодорожке, на тебе должна быть одежда со светоотражающими полосками (или жилет), чтобы тебя видели водители.
Ключевые слова: велосипед, ночь, фонари, свет, жилет.
---
Статья 150-151. Как пересекать дорогу на велосипеде и самокате
Текст: Когда ты подъезжаешь к пешеходному переходу ("зебре"):
1. Обязательно сбавь скорость! Ты должен ехать со скоростью идущего человека (шагом).
2. Убедись, что машины тебя пропускают.
3. Теперь можно переезжать дорогу. (Раньше нужно было обязательно слезать, сейчас можно ехать, но очень медленно и осторожно).
Ключевые слова: пересечение дороги, велосипед, самокат, скорость шага.
---
Статья 153. Запреты для велосипедистов и самокатчиков
Текст: Тебе запрещено:
1. Ездить, не держась за руль (хотя бы одной рукой).
2. Ездить в снегопад или гололед (очень скользко и опасно!).
3. Катать пассажиров на раме или багажнике (если нет специального детского кресла).
4. Везти груз, который мешает управлять или торчит в стороны (например, длинную палку).
Ключевые слова: запреты, трюки, гололед, пассажиры на велосипеде.
---
Статья 154. Возраст велосипедиста
Текст: Выезжать на настоящую автомобильную дорогу на велосипеде без взрослых можно только с **14 лет**. До этого возраста катайся только по тротуарам, пешеходным и велосипедным дорожкам, стадионам или паркам.
Ключевые слова: 14 лет, возраст, дорога, велосипед.
---
Статья 156-1. Правила для электросамокатов (СПМ)
Текст:
1. Нельзя разгоняться быстрее 25 км/ч.
2. Нельзя ехать вдвоем на одном самокате (это очень опасно!).
3. Если тебе нет 14 лет, кататься можно только в пешеходных, жилых зонах или на тротуарах, но не на дороге.
Ключевые слова: электросамокат, скорость, возраст, вдвоем нельзя.
---
Статья 156-2. Шлем
Текст: Правила **рекомендуют** надевать шлем, когда ты едешь на электросамокате или велосипеде. Это не обязательно по закону, но это может спасти твою голову при падении.
Ключевые слова: шлем, защита, безопасность.
---
Статья 178-181. Перевозка детей
Текст: Если тебе меньше 12 лет (и твой рост меньше 150 см), в машине ты должен ехать в специальном детском кресле (бустере). Нельзя сидеть на коленях у взрослых. На мотоцикле детям до 12 лет ездить вообще нельзя.
Ключевые слова: детское кресло, бустер, 12 лет, автомобиль.
"""
    },
    {
        "topic": "Трудоустройство",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 11. Твои права на работе Текст: Каждый человек, который работает, имеет права. Ты имеешь право сам выбирать, кем быть и где работать (по призванию и способностям). Ты имеешь право на зарплату, чтобы тебе и твоей семье хватало на достойную жизнь. Также у тебя есть право на отдых (выходные и отпуск), на безопасное рабочее место (чтобы ничего не упало на голову и было светло) и на уважение (никто не должен тебя обижать или лезть в твою личную жизнь). Ключевые слова: права работника, выбор профессии, зарплата, отдых, безопасность, уважение.
Статья 21. Во сколько лет можно начать работать Текст: Обычно на работу можно устраиваться, когда тебе исполнится 16 лет. Но если тебе уже есть 14 лет, ты тоже можешь работать, но только с письменного разрешения одного из родителей (мамы или папы). При этом работа должна быть легкой и не мешать твоей учебе в школе. Ключевые слова: возраст, 14 лет, 16 лет, разрешение родителей, первая работа, школа.
Статья 26. Какие документы нужны для работы Текст: Когда ты устраиваешься на работу, ты должен показать начальнику (нанимателю) свой паспорт (или другой документ, подтверждающий личность). Если это твоя не первая работа, нужна трудовая книжка (это такая книжка, где записано, где ты работал раньше). Также могут попросить диплом об образовании (если работа требует специальных знаний) и справку от врача, что ты здоров. Запрещено требовать документы, которые не нужны по закону (например, просить дневник с оценками). Ключевые слова: документы, паспорт, трудовая книжка, справка от врача, прием на работу.
Статья 53. Что ты обязан делать на работе Текст: Если ты устроился на работу, ты должен выполнять свои обязанности честно и старательно. Нужно слушаться начальника, соблюдать правила (приходить вовремя, не бегать по офису), беречь вещи и оборудование фирмы. Также важно соблюдать технику безопасности (надевать каску, если нужно) и хранить секреты фирмы (не рассказывать посторонним пароли или планы компании). Ключевые слова: обязанности, дисциплина, честность, правила, бережливость, секреты.
Статья 114. Сколько времени можно работать детям Текст: Детям нельзя работать так же много, как взрослым. Если тебе от 14 до 16 лет, ты можешь работать не больше 23 часов в неделю. Если тебе от 16 до 18 лет — не больше 35 часов в неделю. Если ты еще учишься в школе и работаешь в свободное время, то это время делится пополам: для 14–16 лет — около 11,5 часов в неделю, для 16–18 лет — около 17,5 часов. Ключевые слова: рабочее время, часы работы, подростки, школа, свободное время.
Статья 197. Что будет, если плохо себя вести Текст: Если ты нарушаешь правила (опаздываешь, не делаешь работу или грубишь), это называется "дисциплинарный проступок". За это начальник может тебя наказать. Это не значит, что тебя поставят в угол. Наказания бывают такие: замечание (просто скажут, что так нельзя), выговор (строгое предупреждение) или увольнение (тебя попросят уйти с работы). Ключевые слова: наказание, проступок, опоздание, замечание, выговор, увольнение.
Статья 274. Запрещенная работа для детей Текст: Людям младше 18 лет запрещено выполнять опасную и очень тяжелую работу. Тебя не могут заставить таскать тяжести, работать под землей (например, в шахте) или там, где есть вредные вещества. Это сделано, чтобы сберечь твое здоровье и чтобы ты нормально рос и развивался. Ключевые слова: запреты, опасная работа, тяжести, здоровье, шахта, вредность.
Статья 277. Отпуск для подростков Текст: Если тебе еще нет 18 лет, начальник обязан отпускать тебя в отпуск летом, чтобы ты мог отдохнуть, как на каникулах. Но если ты сам захочешь, ты можешь попросить отпуск и в любое другое время года. Ключевые слова: отпуск, лето, каникулы, отдых, подростки.
"""
    },
    {
        "topic": "Права ребёнка",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 1. Кто считается ребенком
Текст: По закону ребенком считается любой человек, которому еще не исполнилось 18 лет. Все правила этого закона действуют для тебя до наступления совершеннолетия.
Ключевые слова: возраст, 18 лет, совершеннолетие, кто я.
Статья 4. Право на жизнь
Текст: Твое самое главное право — это право на жизнь. Никто не имеет права причинять тебе вред или угрожать твоей жизни. Государство обязано защищать тебя от любых преступников. Даже самых страшных наказаний (как смертная казнь или тюрьма на всю жизнь) для детей не существует.
Ключевые слова: жизнь, безопасность, защита, наказание.
Статья 5. Право на здоровье
Текст: Ты имеешь право расти здоровым и сильным. Если ты заболеешь, врачи должны лечить тебя бесплатно. Также ты можешь поехать в санаторий, чтобы подлечиться и отдохнуть.
Ключевые слова: здоровье, врачи, больница, лечение, бесплатно.
Статья 6. Все дети равны
Текст: Неважно, мальчик ты или девочка, на каком языке говоришь, богатая у тебя семья или нет, здоров ты или болеешь — у всех детей абсолютно одинаковые права.
Ключевые слова: равенство, мальчики и девочки, справедливость.
Статья 8. Право на нормальную жизнь
Текст: У тебя должно быть все необходимое, чтобы ты мог нормально расти и развиваться: еда, одежда, дом и условия для учебы. Ты имеешь право развиваться физически (спорт), умственно (школа) и духовно.
Ключевые слова: развитие, уровень жизни, еда, одежда.
Статья 9. Защита от насилия и плохих привычек
Текст: Никто не имеет права бить тебя, обижать, издеваться или заставлять делать плохие вещи. Взрослые должны защищать тебя от наркотиков, алкоголя, сигарет и от людей, которые могут предложить тебе попробовать это. Тебя нельзя заставлять просить милостыню или играть в азартные игры на деньги. Если кто-то обижает тебя, об этом нужно срочно рассказать взрослым или полиции.
Ключевые слова: насилие, защита, алкоголь, наркотики, безопасность, нельзя бить.
Статья 10. Твоя вера
Текст: Ты сам можешь решать, верить в Бога или нет, и какую религию выбрать. Никто не может заставлять тебя участвовать в обрядах, если ты этого не хочешь. Но пока тебе не исполнилось 15 лет, вопросы религии решаются с согласия твоих родителей.
Ключевые слова: религия, вера, церковь, выбор, 15 лет.
Статья 11. Твое мнение и информация
Текст: Ты имеешь право искать и получать полезную информацию (читать книги, смотреть новости). Ты можешь свободно говорить то, что думаешь. Если решается вопрос, который касается лично тебя, взрослые обязаны выслушать твое мнение. Даже в суде ты имеешь право быть услышанным.
Ключевые слова: мнение, слово, информация, меня должны слушать.
Статья 12. Проезд в транспорте
Текст: У детей есть право на льготы при поездках в автобусах, поездах и другом транспорте (например, бесплатный проезд или билет дешевле, чем у взрослых).
Ключевые слова: автобус, проезд, билет, льгота.
Статья 13. Как защитить свои права (важный возраст — 14 лет)
Текст: Если твои права нарушают, ты всегда можешь пожаловаться в милицию, органы опеки или прокуратуру. Когда тебе исполнится 14 лет, ты получаешь право самостоятельно обращаться в суд и просить помощи у адвоката без разрешения родителей. Юридическая помощь для детей оказывается адвокатами бесплатно.
Ключевые слова: 14 лет, суд, адвокат, защита, жалоба, милиция.
Статья 14. Твои обязанности
Текст: У тебя есть не только права, но и обязанности. Ты должен:
* Соблюдать законы.
* Заботиться о своих родителях.
* Уважать права других людей и традиции своей страны.
* Беречь свое здоровье.
* Хорошо учиться и готовиться к будущей работе.
* Беречь природу.
Ключевые слова: обязанности, правила, учеба, родители, природа.
Статья 15. Жизнь в семье
Текст: Ты имеешь право жить со своими родителями, знать их и получать от них заботу. Когда тебе исполнится 10 лет, если родители живут раздельно, суд обязательно спросит твое мнение: с кем из них ты хочешь жить.
Ключевые слова: семья, родители, 10 лет, выбор, развод.
Статья 16. Если родители не живут вместе
Текст: Даже если один из родителей живет в другом доме или другой стране, ты имеешь полное право общаться с ним, созваниваться и видеться. Запретить это могут только если такое общение тебе вредит.
Ключевые слова: папа и мама, общение, встречи.
Статья 17. Ответственность родителей и "Комендантский час"
Текст: Родители отвечают за твое воспитание и учебу. Также есть важное правило: если тебе еще нет 16 лет, ты не можешь находиться на улице один с 23:00 до 06:00 утра. В это время ты должен быть либо дома, либо рядом со взрослыми. Если ты что-то нарушишь, отвечать за это придется твоим родителям.
Ключевые слова: родители, воспитание, 16 лет, ночь, гулять, комендантский час, 23:00.
Статья 19. Твои вещи и деньги
Текст: Ты можешь иметь свои вещи и даже имущество (например, подарок или наследство). Ты имеешь право пользоваться ими. Также ты имеешь право получить наследство от родителей.
Ключевые слова: вещи, собственность, подарки, наследство.
Статья 23. Право на образование
Текст: Каждый ребенок имеет право учиться. Школьное образование для тебя бесплатно. Государство помогает развивать твои таланты.
Ключевые слова: школа, учеба, образование, бесплатно, талант.
Статья 24. Право на работу (подработка)
Текст: Ты имеешь право выбирать профессию по душе.
* С 16 лет ты можешь устраиваться на работу самостоятельно.
* С 14 лет ты можешь работать, но только с письменного разрешения одного из родителей и в свободное от учебы время.
* Детям запрещено работать на тяжелых, вредных и опасных работах (например, под землей).
Ключевые слова: работа, деньги, 14 лет, 16 лет, разрешение родителей.
Статья 25. Отдых
Текст: У тебя есть законное право на отдых, игры и любимые занятия в свободное время. Ты можешь ходить в кружки, секции и лагеря.
Ключевые слова: отдых, игры, хобби, кружки, каникулы.
Статья 27. Честь и достоинство в школе
Текст: Никто не имеет права тебя унижать или оскорблять. Это касается и учителей, и тренеров. Дисциплина в школе должна строиться на уважении, а не на страхе. Если учитель унижает ученика, он будет наказан по закону.
Ключевые слова: школа, учитель, уважение, нельзя дразнить, достоинство.
Статья 28. Твои секреты
Текст: Никто не имеет права читать твои личные письма, сообщения в телефоне или подслушивать разговоры без законных оснований. Это твоя частная жизнь.
Ключевые слова: секрет, телефон, письма, переписка, личное.
Статья 29. Если нет родителей
Текст: Если у ребенка нет родителей, государство берет заботу о нем на себя. Такого ребенка стараются устроить в новую семью (приемную или к родственникам), чтобы ему было хорошо. Детский дом — это крайняя мера, если семью найти не удалось.
Ключевые слова: сирота, приемная семья, опека, помощь.
Статья 31. Дети с особенностями
Текст: Если у ребенка есть инвалидность или особенности развития, государство помогает ему особо: бесплатное лечение, специальные школы, помощь психологов. Делается всё, чтобы такой ребенок мог жить полноценной жизнью и дружить с другими детьми.
Ключевые слова: инвалидность, помощь, поддержка, особенные дети.
Статья 33. Нет войне
Текст: Детей запрещено брать в армию и отправлять на войну. Пропагандировать войну среди детей тоже нельзя.
Ключевые слова: война, армия, мир.
Статья 35. Если ребенок нарушил закон
Текст: Даже если ребенок совершил преступление, у него остаются права. С ним должны обращаться гуманно, и у него есть право на защиту.
Ключевые слова: полиция, нарушение, арест.
Статья 37-1. Вредная информация
Текст: Ты имеешь право на защиту от информации, которая может тебе навредить.
Вредной считается информация, которая:
* Учит пить алкоголь, курить или принимать наркотики.
* Призывает к преступлениям или насилию.
* Содержит плохие (нецензурные) слова.
* Показывает жестокость или пугает страшными картинками.
Ключевые слова: интернет, плохие слова, жестокость, вредная информация.
"""
    },
    {
        "topic": "Семья",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 12. Что такое брак Текст: Брак — это когда мужчина и женщина добровольно решают создать семью. Никто не может заставить человека жениться или выйти замуж насильно. У мужа и жены появляются общие права и обязанности. Ключевые слова: свадьба, семья, муж и жена, создание семьи.
Статья 13. Брачный договор (Контракт) Текст: Муж и жена могут подписать специальный документ — Брачный договор. В нем они заранее договариваются, как будут тратить деньги, кому достанется квартира или машина, если они вдруг решат расстаться, и как они будут воспитывать детей. Ключевые слова: договор, деньги, имущество, правила семьи.
Статья 18. Когда можно жениться Текст: Жениться или выходить замуж можно с 18 лет. В особых случаях (например, если девушка ждет ребенка) разрешается вступить в брак с 15 лет, но только если на это есть веская причина. Ключевые слова: возраст, свадьба, 18 лет, совершеннолетие.
Статья 19. На ком нельзя жениться Текст: Нельзя жениться на брате, сестре, маме, папе, бабушке, дедушке (даже если они не родные, а приемные). Также нельзя вступать в брак, если ты уже женат или замужем за кем-то другим. Ключевые слова: запреты, родственники, брат и сестра.
Статья 20-21. Равенство в семье и выбор фамилии Текст: Муж и жена в семье главные поровну. Все важные вопросы они решают вместе. При свадьбе они могут взять одну общую фамилию, оставить свои или сделать двойную фамилию (через черточку). Ключевые слова: фамилия, равноправие, решение проблем.
Статья 23. Общие вещи (Совместная собственность) Текст: Всё, что муж и жена купили после свадьбы (мебель, машина, квартира), считается их общим. Неважно, кто именно заработал деньги или на чье имя записана покупка — это принадлежит им обоим. Ключевые слова: покупки, общие вещи, имущество.
Статья 26. Личные вещи Текст: Вещи, которые были у мужа или жены до свадьбы, а также подарки и наследство — это их личная собственность. Твоя одежда, обувь и школьные принадлежности считаются вещами того, кто ими пользуется. Ключевые слова: подарки, мои вещи, личное.
Статья 29. Помощь друг другу Текст: Муж и жена должны помогать друг другу деньгами и заботой. Если один из них заболел или не может работать (например, мама ухаживает за маленьким ребенком), второй обязан его содержать. Ключевые слова: забота, деньги, помощь.
Статья 35. Когда нельзя разводиться Текст: Муж не может потребовать развода без согласия жены, если она ждет ребенка или если их ребенку еще нет 3 лет. Это сделано для защиты мамы и малыша. Ключевые слова: развод, беременность, малыш, защита мамы.
Статья 59. Что такое семья Текст: Семья — это люди, которые связаны родством или браком, живут вместе, ведут общее хозяйство и заботятся друг о друге. Ключевые слова: семья, родные, забота.
Статья 65-66. Главная задача семьи Текст: Семья — это лучшее место для ребенка. Родители обязаны защищать тебя, воспитывать и содержать (кормить, одевать). Государство помогает семьям, особенно многодетным. Ключевые слова: воспитание, защита, безопасность.
Статья 67. Плохое воспитание (СОП) Текст: Если родители не кормят ребенка, не следят за ним, обижают его или ведут себя плохо (например, много пьют алкоголь), такая семья считается находящейся в «социально опасном положении». Государство берет такую семью под контроль, чтобы помочь ребенку. Ключевые слова: опасность, СОП, плохие родители, контроль.
Статья 68. Обязанности родителей Текст: Родители обязаны дать тебе имя, заботиться о твоем здоровье, следить, чтобы ты ходил в школу, и защищать твои права перед другими людьми. Ключевые слова: школа, здоровье, имя, защита.
Статья 69. Имя ребенка Текст: Имя ребенку выбирают родители по обоюдному согласию. Ребенку можно дать не больше двух имен. Фамилия дается папина или мамина. Ключевые слова: выбор имени, как назвать.
Статья 70. Смена фамилии Текст: Если тебе уже исполнилось 10 лет, родители не могут поменять твою фамилию без твоего согласия. Твое мнение обязательно спросят. Ключевые слова: 10 лет, смена фамилии, мое мнение.
Статья 74. Где должен жить ребенок Текст: Ребенок живет там же, где его родители. Если родители разводятся и живут отдельно, они договариваются, с кем останется ребенок. Если тебе уже 10 лет, суд обязательно спросит, с кем из родителей ты хочешь жить. Ключевые слова: место жительства, переезд, развод, 10 лет.
Статья 75. Воспитание Текст: Вопросы воспитания (в какую школу ходить, какую религию исповедовать, чем заниматься в свободное время) родители решают вместе. Ты тоже имеешь право голоса в семье. Ключевые слова: школа, кружки, вера.
Статья 76. Папа и мама равны Текст: Папа и мама имеют одинаковые права и обязанности по отношению к тебе, даже если они развелись и не живут вместе. Ключевые слова: развод, права родителей.
Статья 77. Родитель, который живет отдельно Текст: Если папа (или мама) живет не с тобой, он всё равно имеет право видеться с тобой, общаться и участвовать в твоем воспитании. Второй родитель не должен этому мешать, если это не вредит тебе. Ключевые слова: встречи, общение, папа выходного дня.
Статья 78. Общение с родственниками Текст: Ты имеешь полное право общаться с бабушками, дедушками, братьями и сестрами, даже если твои родители в ссоре с ними. Если родители запрещают тебе видеть бабушку, суд может разрешить эти встречи. С 10 лет твое желание видеться с родными обязательно учитывается. Ключевые слова: бабушка, дедушка, брат, сестра, встречи.
Статья 80. Лишение родительских прав Текст: Это очень строгая мера. Суд может забрать у родителей право называться мамой и папой, если они жестоко обращаются с ребенком, являются алкоголиками, наркоманами или совсем не заботятся о ребенке. Ключевые слова: наказание родителей, опасность, алкоголизм, жестокость.
Статья 85. Отобрание ребенка Текст: Если находиться дома с родителями опасно для жизни или здоровья ребенка, специальные службы могут немедленно забрать ребенка в безопасное место (в приют или больницу), даже без лишения родителей прав. Это делается для спасения ребенка. Ключевые слова: спасение, приют, опасность дома.
Статья 88-89. Деньги и имущество ребенка Текст: У тебя могут быть свои вещи и деньги. Родители управляют твоим имуществом, но они не могут продать твою квартиру или отказаться от твоего наследства без разрешения органов опеки. Они обязаны беречь твое имущество. Ключевые слова: мои деньги, квартира, продажа, наследство.
Статья 91. Алименты (Деньги на ребенка) Текст: Родители обязаны содержать своих детей. Если родитель не живет с семьей, он должен платить деньги на покупку еды, одежды и игрушек для ребенка. Эти деньги называются алименты. Ключевые слова: алименты, деньги, содержание.
Статья 100. Обязанности детей Текст: Дети обязаны заботиться о своих родителях и помогать им. Когда дети станут взрослыми, они должны будут содержать своих нетрудоспособных (пожилых или больных) родителей. Ключевые слова: помощь маме, старость, долг.
Статья 119. Усыновление Текст: Усыновление — это когда чужие взрослые становятся для ребенка настоящими папой и мамой. У них появляются такие же права и обязанности, как у родных родителей. Ключевые слова: приемные родители, новая семья.
Статья 130. Согласие на усыновление Текст: Если тебе исполнилось 10 лет, тебя не могут усыновить, если ты сам этого не хочешь. Твое согласие обязательно. Ключевые слова: 10 лет, согласие, новая семья.
Статья 136. Тайна усыновления Текст: Закон запрещает рассказывать посторонним людям, что ребенок был усыновлен, если родители хотят сохранить это в тайне. Это делается, чтобы никто не лез в жизнь семьи. Ключевые слова: секрет, тайна.
Статья 142. Опека и попечительство Текст: Если у ребенка нет родителей, ему назначают опекуна (для детей до 14 лет) или попечителя (от 14 до 18 лет). Этот человек заменяет родителей: воспитывает, защищает и заботится. Ключевые слова: опекун, сирота, забота.
Статья 158. Где живет опекун Текст: Опекун обязан жить вместе с ребенком. Если тебе уже исполнилось 14 лет, с разрешения органов опеки можно жить раздельно, но опекун всё равно должен о тебе заботиться. Ключевые слова: жилье, 14 лет, совместная жизнь.
Статья 164. Карманные деньги и заработок (14-18 лет) Текст: Если тебе от 14 до 18 лет, ты можешь сам распоряжаться своим заработком (зарплатой, стипендией). Ты также можешь сам совершать мелкие покупки (продукты, билеты). Но если тратить деньги неразумно, суд может ограничить это право. Ключевые слова: карманные деньги, зарплата, покупки, магазин.
Статья 170. Приемная семья Текст: Это профессиональная семья, которая берет детей-сирот на воспитание. Приемные родители получают за это зарплату и деньги на содержание детей, но они обязаны любить и заботиться о детях как о родных. Ключевые слова: работа родителем, сироты, дом.
Статья 179. Кто считается ребенком Текст: Ребенком считается любой человек, которому еще не исполнилось 18 лет. До 14 лет ты — «малолетний», а с 14 до 18 лет — «подросток» (несовершеннолетний). Ключевые слова: возраст, подросток, совершеннолетие.
Статья 181. Права ребенка — главные Текст: Права и интересы ребенка всегда стоят на первом месте. Государство и родители должны в первую очередь думать о том, что будет лучше для тебя. Ключевые слова: главный, права, защита.
Статья 184. Право на жизнь и здоровье Текст: У тебя есть право на жизнь в безопасности. Никто не может обижать тебя. Ты имеешь право на бесплатное лечение у врачей. Ключевые слова: врач, больница, безопасность, жизнь.
Статья 185. Право жить в семье Текст: Каждый ребенок имеет право знать своих родителей и жить с ними (если это не опасно). Если тебе 10 лет, ты можешь выбирать, с кем из родителей жить при разводе. Ключевые слова: семья, выбор, родители.
Статья 186. Учеба и работа Текст: Ты имеешь право бесплатно учиться в школе. Работать самостоятельно можно с 16 лет. С 14 лет работать тоже можно, но только с письменного разрешения одного из родителей и в свободное от учебы время. Ключевые слова: школа, работа, подработка, 14 лет, 16 лет.
Статья 189. Защита от насилия Текст: Никто не имеет права бить тебя, унижать или жестоко обращаться. Если тебя обижают (даже родители), ты можешь пожаловаться в милицию, органы опеки или (если тебе есть 14 лет) пойти в суд. Ключевые слова: насилие, защита, милиция, суд, меня бьют.
Статья 190. Обязанности ребенка Текст: У тебя есть не только права, но и обязанности. Ты должен уважать других людей, соблюдать законы, беречь природу и уважать историю своей страны. Ключевые слова: правила, законы, поведение, уважение.
"""
    },
    {
        "topic": "Образование",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 30. Твои главные права в школе Текст: У тебя есть право бесплатно учиться, пользоваться школьной библиотекой и спортзалом. Ты можешь участвовать в олимпиадах и конкурсах. Если тебе трудно учиться или нужна помощь психолога, школа должна помочь. Также у тебя есть право на каникулы и отдых. Никто не имеет права тебя обижать или оскорблять — ни учителя, ни другие ученики. Ключевые слова: права ученика, библиотека, отдых, защита, помощь, психолог, каникулы.
Статья 31. Твои обязанности (Что ты должен делать) Текст: Ты должен старательно учиться и не прогуливать уроки без причины. Нужно заботиться о своем здоровье и вести себя вежливо с учителями и одноклассниками. Береги школьное имущество (не рисуй на партах, не ломай стулья). Также в школе принято ходить в одежде делового стиля (например, рубашка и брюки или юбка, а не спортивный костюм). Ключевые слова: обязанности, учеба, поведение, вежливость, школьная форма, деловой стиль, имущество.
Статья 33. Права твоих родителей Текст: Твои родители (или опекуны) имеют право знать всё о твоей учебе: какие у тебя оценки, как ты себя ведешь и не прогуливаешь ли уроки. Они могут знакомиться со школьными правилами и защищать твои интересы, если возник спор с учителем. Ключевые слова: родители, оценки, контроль, защита, информация.
Статья 39. Школьные учебники Текст: Пока ты учишься в школе или колледже, тебе выдают учебники. Обычно за пользование ими нужно заплатить небольшую сумму (как за аренду), но для некоторых семей (например, многодетных) это бесплатно или со скидкой. Ключевые слова: учебники, книги, библиотека, бесплатно, школа.
Статья 40. Питание в столовой Текст: В школе обязательно должна быть столовая, чтобы ты мог пообедать. Еда может быть платной (за деньги родителей) или бесплатной (за счет государства), это зависит от правил твоего города и твоей семьи. Ключевые слова: еда, столовая, обед, питание.
Статья 47. Поездка в школу (Школьный автобус) Текст: Если ты живешь в деревне или поселке, где нет своей школы, и тебе нужно ехать на учебу в соседний населенный пункт, тебя должны отвезти туда и обратно бесплатно (на школьном автобусе). Также проезд может быть бесплатным для детей с особенностями развития. Ключевые слова: автобус, проезд, дорога в школу, бесплатно, транспорт.
Статья 118. За что могут наказать (Дисциплинарный проступок) Текст: Дисциплинарный проступок — это когда ты нарушаешь правила. Тебя могут наказать, если ты:
Опаздываешь или прогуливаешь уроки.
Не слушаешься учителя.
Оскорбляешь других людей.
Портишь школьные вещи.
Куришь (в том числе вейпы) или приносишь алкоголь в школу или на школьный двор. Ключевые слова: нарушение, прогул, опоздание, курение, вейп, плохое поведение, оскорбление.
Статья 119. С какого возраста наказывают Текст: Серьезная ответственность начинается с 14 лет. Если ты младше 14 лет и нарушил правила, с тобой просто проведут строгую беседу (педагогическое воздействие). Но если ты старше 14, тебе могут вынести официальное наказание. Ключевые слова: возраст, 14 лет, ответственность, беседа.
Статья 120. Виды наказаний Текст: Если ты серьезно нарушил правила (и тебе уже есть 14 лет), директор может применить к тебе одно из трех наказаний:
Замечание (самое легкое).
Выговор (строгое предупреждение).
Отчисление (тебя исключают из школы). Отчислить могут только за очень серьезные проступки и только если тебе уже исполнилось 16 лет (до 16 лет выгнать из школы почти невозможно, так как ты обязан учиться). Ключевые слова: наказание, замечание, выговор, отчисление, директор.
Статья 126. Как объявляют наказание Текст: Если тебя решили наказать (сделать замечание или выговор), директор издает специальный приказ. Тебе и твоим родителям должны дать прочитать этот документ и попросить расписаться. Если ты не согласен, ты можешь написать объяснительную записку о том, как всё было на самом деле. Ключевые слова: приказ, подпись, родители, объяснительная.
"""
    },
    {
        "topic": "Гражданиский кодекс",
        "q_types": ["single", "multiple", "find-error", "matching", "sequence", "fill-blanks"],
        "legal_text": """
Статья 17. Что ты можешь иметь (Правоспособность) Текст: С момента рождения у тебя есть права. Ты можешь быть хозяином вещей (иметь собственность), получать подарки и наследство, быть автором своих рисунков или изобретений. Ты имеешь право выбирать, где жить (вместе с родителями), и заниматься полезными делами, не запрещенными законом. Ключевые слова: права ребенка, собственность, наследство, авторство.
Статья 18. Твое имя Текст: У тебя есть право на своё имя, которое состоит из фамилии, собственного имени и отчества. Ты должен использовать его в официальных ситуациях. Если захочешь, имя можно поменять, но по специальным правилам. Никто не имеет права использовать твое имя без разрешения, чтобы навредить тебе. Ключевые слова: имя, фамилия, отчество, смена имени.
Статья 19. Где ты живешь (Место жительства) Текст: Твоим домом считается то место, где ты живешь постоянно или большую часть времени. Пока тебе не исполнилось 14 лет, твоим официальным местом жительства считается дом твоих родителей или опекунов. Ключевые слова: дом, адрес, место жительства, родители, до 14 лет.
Статья 20. Когда становишься взрослым (Дееспособность) Текст: Полная взрослая самостоятельность наступает в 18 лет. С этого возраста ты можешь сам заключать любые договоры и отвечать за свои поступки. Иногда стать полностью взрослым по документам можно раньше — если вступишь в брак или начнешь работать (эмансипация), но это исключительные случаи. Ключевые слова: совершеннолетие, 18 лет, взрослая жизнь.
Статья 25. Права подростков (от 14 до 18 лет) Текст: Если тебе от 14 до 18 лет, у тебя появляется больше свободы, но серьезные сделки (например, продать квартиру или дорогую технику) ты можешь делать только с письменного разрешения родителей. Однако ты уже можешь сам, без спроса родителей:
Тратить свою стипендию или заработанные деньги.
Быть автором и защищать свои права на программы, стихи или изобретения.
Открывать счет в банке и класть туда деньги.
Совершать мелкие покупки в магазине (продукты, канцтовары). За вред, который ты причинишь другим, в этом возрасте ты уже отвечаешь сам (своими деньгами). Ключевые слова: подросток, 14-18 лет, карманные деньги, заработок, ответственность, банк.
Статья 26. Как стать взрослым в 16 (Эмансипация) Текст: Если тебе уже исполнилось 16 лет и ты работаешь по трудовому договору или занимаешься бизнесом (с согласия родителей), тебя могут объявить полностью взрослым (дееспособным). Это значит, что ты сам отвечаешь за все свои долги и поступки, а родители за тебя больше не платят. Ключевые слова: эмансипация, работа, 16 лет, полная ответственность.
Статья 27. Права детей (до 14 лет) Текст: Пока тебе нет 14 лет, ты считаешься "малолетним". Серьезные сделки за тебя совершают только родители. Но ты можешь сам:
Совершать мелкие бытовые покупки (купить хлеб, мороженое, билет на автобус, тетрадку).
Принимать подарки, если это не требует регистрации (например, подаренную игрушку или книгу). Если ты что-то сломаешь или испортишь, платить за это будут твои родители. Ключевые слова: дети, до 14 лет, мелкие покупки, подарки, ответственность родителей.
Статья 28. Деньги в банке для малышей Текст: Если кто-то (например, бабушка) положил деньги на счет в банке на твое имя, пока ты маленький (до 14 лет), этими деньгами управляют твои родители. Они следят, чтобы деньги сохранились для тебя. Ключевые слова: вклад, банк, деньги, родители."""
    }
]

def get_prompt_for_type(q_type, topic, legal_text, count_needed):

    base_role = f"""
    РОЛЬ: Ты педагог для детей 8-12 лет. Ты создаешь викторину по теме "{topic}".
    ИСТОЧНИК (Закон): "{legal_text}..."
    ЗАДАЧА: Сгенерируй {count_needed} вопросов в формате JSON.
    ЯЗЫК: Русский. Простой, понятный детям. Без канцеляризмов ("данное лицо", "осуществляет").
    ПОДСКАЗКА (hint): Должна сильно помогать в нахождении ответа, но не раскрывать его.
    """

    type_instructions = {
        "single": """
        ТИП: Одиночный выбор (single).
        ТРЕБОВАНИЯ:
        1. Ситуация должна быть жизненной (школа, улица, дом).
        2. "options": 4 варианта. Только 1 правильный.
        3. Неправильные ответы должны быть: смешными, опасными, абсурдными или с типичными детскими ошибками.
        ШАБЛОН JSON:
        {
            "type": "single",
            "question": "Текст вопроса?",
            "options": ["Неверно", "Верно", "Неверно", "Неверно"],
            "correct": 1,
            "hint": "Подсказка"
        }
        """,

        "multiple": """
        ТИП: Множественный выбор (multiple).
        КРИТИЧЕСКИ ВАЖНО:
        1. В поле "correct" ДОЛЖНО быть МИНИМУМ 2 индекса (например, [0, 2] или [1, 3, 0]).
        2. Вопрос должен подразумевать несколько действий (например, "Что МОЖНО делать?").
        3. Если правильный ответ только один — это ошибка генерации.
        4. Неправильные ответы должны быть: смешными, опасными, абсурдными или с типичными детскими ошибками.
        ШАБЛОН JSON:
        {
            "type": "multiple",
            "question": "Выберите ВСЕ правильные действия:",
            "options": ["Правильно 1", "Опасно", "Правильно 2", "Глупо"],
            "correct": [0, 2],
            "hint": "Подсказка"
        }
        """,

        "matching": """
        ТИП: Соедини пары (matching).
        ТРЕБОВАНИЯ:
        1. Логика должна быть "железобетонной". Не должно быть так, что вариант А подходит и к 1, и к 2.
        2. Используй связи: "Нарушение -> Наказание", "Знак -> Значение", "Действие -> Последствие" и так далее.
        3. 3 или 4 пары.
        ШАБЛОН JSON:
        {
            "type": "matching",
            "question": "Соедини символы и их значения",
            "leftItems": ["Символ 1", "Символ 2"],
            "rightItems": ["Значение 1", "Значение 2"],
            "correctPairs": {
                "Символ 1": "Значение 1",
                "Символ 2": "Значение 2"
            },
            "hint": "Подсказка"
        }
        """,

        "sequence": """
        ТИП: Восстанови порядок (sequence).
        КРИТИЧЕСКИ ВАЖНО:
        1. Шаги должны быть ФИЗИЧЕСКИМИ и НЕОБРАТИМЫМИ во времени. 
        2. ПЛОХО: "Подумать" -> "Решить" (это происходит в голове, дети путаются).
        3. ХОРОШО: "Подойти к переходу" -> "Посмотреть по сторонам" -> "Пойти" (нельзя пойти, не подойдя).
        4. Если шаги можно поменять без потери смысла - вопрос некорректен.
        5. От 3 до 5 шагов.
        6. Генерируй простые вопросы, насколько это возможно
        ШАБЛОН JSON:
        {
            "type": "sequence",
            "question": "Расставь действия по порядку",
            "steps": ["Шаг 2", "Шаг 1", "Шаг 3"],
            "correctOrder": [1, 0, 2],
            "hint": "Подсказка"
        }
        """,

        "find-error": """
        ТИП: Найди ошибку (find-error).
        ТРЕБОВАНИЯ:
        1. Дается список правил, действий или фактов. Одно из них — НЕВЕРНОЕ, ОПАСНОЕ или ПРОТИВОЗАКОННОЕ.
        2. Это не должна быть орфографическая ошибка. Это ошибка поведения.
        3. Неправильный ответ должен быть: смешным, опасным, абсурдным или с типичными детскими ошибками.
        4. Остальные варианты - абсолютно верные
        ШАБЛОН JSON:
        {
            "type": "find-error",
            "question": "Найди лишнее",
            "code": [
                "Верно 1",
                "Верно 2",
                "Неверно"
            ],
            "errorLine": 2,
            "hint": "Подсказка"
        }
        """,

        "fill-blanks": """
        ТИП: Вставь пропущенное слово (fill-blanks).
        ТРЕБОВАНИЯ:
        1. Предложение из закона, но максимально упрощенное.
        2. Пропущено КЛЮЧЕВОЕ слово.
        3. В options даются варианты этого слова.
        4. Неправильные ответы должны быть: смешными, опасными, абсурдными или с типичными детскими ошибками.
        ШАБЛОН JSON:
        {
            "type": "fill-blanks", 
            "question": "Заполни пропуски в тексте",
            "code": "Текст до <span class=\\"blank\\" data-id=\\"1\\">______</span> текст между <span class=\\"blank\\" data-id=\\"2\\">______</span> текст после.",
            "blanks": {
                "1": ["правильный1", "неверный1", "неверный2"],
                "2": ["неверный1", "правильный2"]
            },
            "correct": ["правильный1", "правильный2"],
            "hint": "Подсказка по смыслу пропущенных слов"
        }
        """
    }

    specific_instr = type_instructions.get(q_type, type_instructions['single'])

    full_prompt = f"""
    {base_role}

    {specific_instr}

    ВЫВОД: Только валидный JSON массив объектов [{count_needed} шт]. Без лишнего текста.
    """
    return full_prompt


def load_existing_questions():
    """Загружает существующие вопросы и считает статистику."""
    if not os.path.exists(OUTPUT_FILE):
        return [], {}

    try:
        with open(OUTPUT_FILE, 'r', encoding='utf-8') as f:
            data = json.load(f)

        stats = {}
        for q in data:
            t = q.get('theme', 'Unknown')
            qt = q.get('type', 'unknown')
            if t not in stats: stats[t] = {}
            if qt not in stats[t]: stats[t][qt] = 0
            stats[t][qt] += 1

        return data, stats
    except Exception as e:
        logger.error(f"Ошибка чтения файла {OUTPUT_FILE}: {e}")
        return [], {}


def extract_json_from_text(text: str):
    """Надежный парсер JSON из ответа LLM."""
    try:
        # Пытаемся найти массив
        match = re.search(r'\[.*\]', text, re.DOTALL)
        if match: return json.loads(match.group(0))
        # Пытаемся найти одиночный объект
        match_obj = re.search(r'\{.*\}', text, re.DOTALL)
        if match_obj: return [json.loads(match_obj.group(0))]
        return None
    except:
        return None


def validate_question(q):
    """Строгая валидация."""
    try:
        if not isinstance(q, dict): return False
        if len(q.get('question', '')) > 300: return False  # Слишком длинно

        q_type = q.get('type')

        # Валидация Multiple
        if q_type == 'multiple':
            if not isinstance(q.get('correct'), list) or len(q['correct']) < 2:
                logger.warning(f"⚠️ Multiple должен иметь >= 2 ответов: {q['question']}")
                return False

        # Валидация Sequence
        if q_type == 'sequence':
            steps = q.get('steps', [])
            if len(steps) < 3: return False
            if len(set(steps)) != len(steps): return False  # Дубликаты

        # Валидация индексов (общая)
        if 'options' in q and isinstance(q['correct'], int):
            if q['correct'] >= len(q['options']) or q['correct'] < 0: return False

        return True
    except Exception as e:
        logger.error(f"Validation Error: {e}")
        return False


def generate_batch(topic, q_type, legal_text, count_needed):
    """Генерирует партию вопросов."""
    # Ограничиваем запрос, чтобы не просить слишком много за раз (макс BATCH_SIZE)
    request_count = min(count_needed, BATCH_SIZE)

    prompt = get_prompt_for_type(q_type, topic, legal_text, request_count)

    headers = {"Authorization": f"Bearer {GROQ_API_KEY}", "Content-Type": "application/json"}
    data = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": "You are a helpful JSON generator assistant. Output ONLY JSON."},
            {"role": "user", "content": prompt}
        ],
        "temperature": 0.4  # Чуть повыше, чтобы вопросы были разнообразнее, но не бред
    }

    try:
        response = requests.post(GROQ_API_URL, headers=headers, json=data)

        if response.status_code == 429:
            logger.warning("⏳ Rate Limit 429. Ждем 15 сек...")
            time.sleep(15)
            return []

        if response.status_code != 200:
            logger.error(f"API Error {response.status_code}: {response.text}")
            return []

        content = response.json()['choices'][0]['message']['content']
        result_json = extract_json_from_text(content)

        valid_batch = []
        if result_json:
            for q in result_json:
                if validate_question(q):
                    q['theme'] = topic
                    # Создаем уникальный ID
                    uniq_str = f"{topic}_{q['question']}"
                    q['id'] = hashlib.md5(uniq_str.encode()).hexdigest()
                    valid_batch.append(q)

        return valid_batch

    except Exception as e:
        logger.error(f"Exception during generation: {e}")
        return []


def main():
    if not CONTEXT_REGISTRY:
        logger.error("Нет данных в CONTEXT_REGISTRY")
        return

    # 1. Загружаем текущее состояние
    all_questions, stats = load_existing_questions()
    logger.info(f"📂 Загружено {len(all_questions)} вопросов. Анализ недостающих...")

    total_added = 0

    # 2. Проходим по темам и типам
    for context in CONTEXT_REGISTRY:
        topic = context['topic']
        legal_text = context['legal_text']

        logger.info(f"--- Тема: {topic} ---")

        for q_type in context['q_types']:
            # Сколько уже есть?
            current_count = stats.get(topic, {}).get(q_type, 0)
            needed = TARGET_PER_TYPE - current_count

            if needed <= 0:
                logger.info(f"✅ {q_type}: уже есть {current_count} (Цель: {TARGET_PER_TYPE}). Пропуск.")
                continue

            logger.info(f"🔄 {q_type}: есть {current_count}. Нужно еще {needed}. Генерируем...")

            # Генерируем пока не заполним квоту (или пока не упремся в лимиты цикла)
            attempts = 0
            while needed > 0 and attempts < 3:
                new_questions = generate_batch(topic, q_type, legal_text, needed)

                # Фильтруем дубликаты (по ID), если вдруг API вернул то же самое
                existing_ids = {q['id'] for q in all_questions}
                unique_new = [q for q in new_questions if q['id'] not in existing_ids]

                if unique_new:
                    all_questions.extend(unique_new)
                    total_added += len(unique_new)
                    needed -= len(unique_new)
                    logger.info(f"   + Добавлено {len(unique_new)} вопросов.")
                else:
                    logger.warning("   ⚠️ Пустая или дублирующая генерация.")

                attempts += 1
                time.sleep(BASE_DELAY)  # Пауза между запросами

            # Промежуточное сохранение после каждого типа вопросов
            with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                json.dump(all_questions, f, ensure_ascii=False, indent=2)

    logger.info(f"🎉 Готово! Всего добавлено в этой сессии: {total_added}. Всего в файле: {len(all_questions)}")


if __name__ == "__main__":
    main()